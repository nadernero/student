<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الخدمة بالكنيسة</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo for Arabic text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS (xlsx) library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js for statistics charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF and html2canvas for exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --color-primary: #06b6d4; /* cyan-500 */
            --color-primary-dark: #0891b2; /* cyan-600 */
            --color-primary-darker: #0e7490; /* cyan-700 */
            --color-primary-light: #ccfbf1; /* cyan-100 */
            --color-primary-text: #115e59; /* cyan-900 */
            
            /* New Color System */
            --color-success: #16a34a; /* green-600 */
            --color-danger: #dc2626;  /* red-600 */
            --color-warning: #f59e0b; /* amber-500 */
            --color-info: #2563eb;    /* blue-600 */
        }
        html.dark {
             --color-primary-light: #22d3ee1a;
             --color-primary-text: #a5f3fc;
        }
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: #f8fafc; /* gray-50 */
            transition: background-color 0.3s ease;
        }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.6); }
        .hidden-view { display: none !important; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link.active { 
            background-color: var(--color-primary);
            color: white; 
            border-right: 4px solid var(--color-primary-darker);
        }
        .sidebar-link:not(.active):hover {
            background-color: var(--color-primary-light);
            color: var(--color-primary-text);
            transform: translateX(-4px);
        }
        .report-tab.active, .activity-filter-btn.active {
            border-color: var(--color-primary);
            background-color: var(--color-primary);
            color: white;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .page-content {
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #a0a0a0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }
        
        /* Typography System */
        .h1 { font-size: 2.25rem; font-weight: 700; } /* 36px */
        .h2 { font-size: 1.5rem; font-weight: 700; }  /* 24px */
        .h3 { font-size: 1.25rem; font-weight: 700; } /* 20px */
        .body-text { font-size: 1rem; font-weight: 400; } /* 16px */
        .small-text { font-size: 0.875rem; } /* 14px */

        /* Theme Toggle Switch */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .theme-switch {
            display: inline-block;
            height: 26px;
            position: relative;
            width: 50px;
        }
        .theme-switch input {
            display:none;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 3px;
            content: "";
            height: 20px;
            left: 3px;
            position: absolute;
            transition: .4s;
            width: 20px;
        }
        input:checked + .slider {
            background-color: var(--color-primary);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="loadingOverlay" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="loader"></div>
    </div>
    
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

    <!-- Login/Services View -->
    <div id="loginOrServicesView">
        <div class="container mx-auto px-4 py-8 md:py-12">
            <header class="text-center mb-10">
                <h1 class="h1 text-blue-800 dark:text-blue-400">نظام إدارة خدمة ابتدائي</h1>
                <h2 class="h2 text-red-800 dark:text-red-400 mt-2">كنيسة مار بولس بالعبور</h2>
                <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">اختر الخدمة التي تريدها</p>
            </header>
            <main id="servicesGrid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-8">
                <!-- Service Cards populated by JS -->
            </main>
        </div>
    </div>

    <!-- Main Dashboard View (Initially Hidden) -->
    <div id="mainDashboard" class="hidden-view">
        <div class="flex h-screen bg-gray-100 dark:bg-gray-800">
            <!-- Sidebar -->
            <nav id="sidebar" class="fixed md:relative inset-y-0 right-0 z-30 w-64 bg-white dark:bg-gray-900 shadow-lg flex flex-col transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
                <div class="p-4 border-b dark:border-gray-700 text-center">
                    <h2 class="h3 text-cyan-600 dark:text-cyan-400">قائمة التحكم</h2>
                    <p id="sidebarServiceName" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div id="sidebarLinks" class="flex-grow pt-4">
                    <a href="#" data-page="homePage" class="sidebar-link active flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-tachometer-alt ml-3 w-6 text-center"></i> لوحة المعلومات</a>
                    <a href="#" data-page="followUpPage" id="followUpLink" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300 hidden-view"><i class="fas fa-clipboard-check ml-3 w-6 text-center"></i> صفحة المتابعة</a>
                    <a href="#" data-page="servantsPage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-users ml-3 w-6 text-center"></i> إدارة الخدام</a>
                    <a href="#" data-page="attendancePage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-check-square ml-3 w-6 text-center"></i> تسجيل الحضور</a>
                    <a href="#" data-page="reportsPage" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300"><i class="fas fa-chart-pie ml-3 w-6 text-center"></i> التقارير والإحصائيات</a>
                    <a href="#" data-page="activityAnalysisPage" id="activityAnalysisLink" class="sidebar-link flex items-center py-3 px-4 text-gray-700 dark:text-gray-300 hidden-view"><i class="fas fa-chart-line ml-3 w-6 text-center"></i> تحليل الأنشطة</a>
                </div>
                <div class="p-4 border-t dark:border-gray-700 space-y-2">
                     <div class="theme-switch-wrapper py-2">
                        <i class="fas fa-moon text-gray-500"></i>
                        <label class="theme-switch" for="theme-checkbox">
                            <input type="checkbox" id="theme-checkbox" />
                            <div class="slider round"></div>
                        </label>
                        <i class="fas fa-sun text-yellow-500"></i>
                    </div>
                    <button id="backToServices" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center">
                        <i class="fas fa-arrow-right-from-bracket mr-2"></i> العودة للخدمات
                    </button>
                    <button id="logoutBtn" class="w-full text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300" style="background-color: var(--color-danger);">تسجيل الخروج</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-y-auto">
                <header class="md:hidden flex justify-between items-center p-4 bg-white dark:bg-gray-900 shadow-md sticky top-0 z-10">
                    <button id="hamburgerBtn" class="text-2xl text-gray-700 dark:text-gray-300" aria-label="فتح القائمة الجانبية">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 id="mobilePageTitle" class="h3 text-cyan-600"></h1>
                </header>

                <div class="p-6 md:p-10 flex-1">
                    <!-- Page: Home / Dashboard -->
                    <div id="homePage" class="page-content">
                        
                        <!-- Service-specific Dashboard -->
                        <div id="serviceDashboardContainer">
                             <h1 class="h1 mb-6">لوحة معلومات الخدمة</h1>
                             <div id="announcementsDisplay" class="mb-6"></div>
                             <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                <div id="totalServantsCard" class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center gap-4 cursor-pointer transition-transform hover:scale-105">
                                    <i class="fas fa-users text-4xl text-cyan-500"></i>
                                    <div>
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">إجمالي الخدام</p>
                                        <p id="totalServantsStat" class="text-3xl font-bold">0</p>
                                    </div>
                                </div>
                                <div class="lg:col-span-1 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                                    <h3 class="font-bold text-pink-600 dark:text-pink-400 mb-2 text-lg flex-shrink-0">أعياد ميلاد قادمة</h3>
                                    <div id="upcomingBirthdayStat" class="overflow-y-auto flex-grow" style="max-height: 100px;">
                                        <!-- Birthday list will be populated here -->
                                    </div>
                                </div>
                                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                                    <h3 class="font-bold text-red-600 dark:text-red-400 mb-2 text-lg">غياب الجمعة الماضية</h3>
                                    <div id="lastFridayAbsenceStat" class="text-sm text-gray-500 dark:text-gray-400 flex-grow">
                                        <!-- Absentee list will be populated here -->
                                    </div>
                                </div>
                                <div class="lg:col-span-4 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                    <h3 class="font-bold text-cyan-600 dark:text-cyan-400 mb-2 text-lg">حالة تسجيل أنشطة الجمعة الماضية</h3>
                                    <div id="lastFridayStatusContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                                        <!-- Activity status will be populated here -->
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                    <h2 class="h2 mb-4">متوسط الحضور (آخر 30 يوم)</h2>
                                    <div class="relative h-80">
                                        <canvas id="homeAttendanceChart"></canvas>
                                    </div>
                                </div>
                                <div class="space-y-6">
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <h2 class="h2 mb-4">إجراءات سريعة</h2>
                                        <div class="space-y-3">
                                            <button id="quickAddServant" class="w-full text-left p-3 rounded-lg bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 hover:bg-green-200 dark:hover:bg-green-800 transition-colors"><i class="fas fa-user-plus w-6 mr-2"></i> إضافة خادم جديد</button>
                                            <button id="quickGoToAttendance" class="w-full text-left p-3 rounded-lg bg-cyan-100 dark:bg-cyan-900 text-cyan-800 dark:text-cyan-200 hover:bg-cyan-200 dark:hover:bg-cyan-800 transition-colors"><i class="fas fa-check-square w-6 mr-2"></i> تسجيل الحضور</button>
                                        </div>
                                    </div>
                                    <div id="backupRestoreSection" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <h2 class="h2 mb-4">النسخ الاحتياطي</h2>
                                        <div class="flex flex-col md:flex-row gap-3">
                                            <button id="backupBtn" class="w-full flex-1 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center justify-center gap-2" style="background-color: var(--color-info);"><i class="fas fa-download"></i> حفظ</button>
                                            <button id="restoreBtn" class="w-full flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all flex items-center justify-center gap-2"><i class="fas fa-upload"></i> استرجاع</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Admin-specific Dashboard (Secretary General) -->
                        <div id="adminDashboardContainer" class="hidden-view">
                            <h1 class="h1 mb-6">لوحة المعلومات الشاملة (الأمين العام)</h1>
                            
                            <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                <!-- Top 2 KPIs will be injected here by JS -->
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">

                                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                                    <h2 class="h2 mb-4">قائمة كل الخدام</h2>
                                    <div class="relative mb-4">
                                        <input type="text" id="adminSearchInput" placeholder="ابحث بالاسم أو الموبايل..." class="w-full p-3 pr-10 rounded-lg bg-gray-50 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 focus:border-cyan-500 focus:outline-none">
                                        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                    <div class="overflow-y-auto flex-grow" style="max-height: 70vh;">
                                        <table class="w-full text-right">
                                            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                                                <tr>
                                                    <th class="p-3 font-bold">الاسم</th>
                                                    <th class="p-3 font-bold">الخدمة</th>
                                                    <th class="p-3 font-bold">الموبايل</th>
                                                </tr>
                                            </thead>
                                            <tbody id="adminServantsTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>

                                <div class="lg:col-span-1 space-y-6">
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <h2 class="h2 mb-4">متوسط الحضور العام (آخر 30 يوم)</h2>
                                        <div class="relative h-80"><canvas id="adminAttendanceChart"></canvas></div>
                                    </div>
                                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                                        <h2 class="h2 mb-4">لوحة الإعلانات المركزية</h2>
                                        <div id="adminAnnouncementsList" class="space-y-3 max-h-40 overflow-y-auto mb-4 pr-2"></div>
                                        <textarea id="newAnnouncementInput" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700" placeholder="اكتب إعلانك الجديد هنا..."></textarea>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-4">توجيه الإعلان إلى:</label>
                                        <div id="announcementTarget" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 h-32 overflow-y-auto space-y-2">
                                            <!-- Checkboxes will be populated by JS -->
                                        </div>
                                        <button id="addAnnouncementBtn" class="mt-3 w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">إضافة إعلان</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- [NEW] Page: Follow-up Page -->
                    <div id="followUpPage" class="page-content hidden-view">
                        <h1 class="h1 mb-6">صفحة المتابعة</h1>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                                <h2 class="h2 mb-2 text-cyan-600 dark:text-cyan-400">متابعة تسجيل الحضور</h2>
                                <div id="attendanceFollowUpPanel" class="flex-grow flex flex-col overflow-hidden">
                                    <!-- Content injected by JS will go here -->
                                </div>
                            </div>
                            <div class="space-y-6">
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                                    <h2 class="h2 mb-4">خدام بحاجة للمتابعة</h2>
                                    <div id="followUpPanel" class="overflow-y-auto flex-grow space-y-2" style="max-height: 40vh;">
                                        <!-- Follow-up list will be injected here -->
                                    </div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                                    <h2 class="h2 mb-4 text-pink-600 dark:text-pink-400">أعياد ميلاد قادمة (30 يوم)</h2>
                                    <div id="birthdaysPanel" class="overflow-y-auto flex-grow space-y-2" style="max-height: 40vh;">
                                        <!-- Birthdays list will be injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Page: Servants Management -->
                    <div id="servantsPage" class="page-content hidden-view">
                         <h1 class="h1 mb-6">إدارة الخدام</h1>
                         <div id="birthdayAlertsContainer" class="mb-6"></div>
                        <div id="servantsActions" class="flex flex-col md:flex-row gap-4 mb-6">
                            <div class="relative flex-grow">
                                <input type="text" id="searchInput" placeholder="ابحث بالاسم أو الموبايل..." class="w-full p-3 pr-10 rounded-lg bg-white dark:bg-gray-700 border-2 border-gray-300 dark:border-gray-600 focus:border-cyan-500 focus:outline-none">
                                <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="addManualBtn" class="w-full md:w-auto text-white font-bold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition-all" style="background-color: var(--color-success);"><i class="fas fa-plus mr-2"></i> إضافة خادم</button>
                            <button id="importExcelBtn" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:shadow-lg transition-all"><i class="fas fa-file-excel mr-2"></i> استيراد Excel</button>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-x-auto">
                            <table class="w-full text-right min-w-[1200px]">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="p-4 font-bold">الصورة</th>
                                        <th class="p-4 font-bold">الاسم</th>
                                        <th id="serviceColumnHeader" class="p-4 font-bold hidden-view">الخدمة</th>
                                        <th class="p-4 font-bold">الموبايل</th>
                                        <th class="p-4 font-bold">ت. الميلاد</th>
                                        <th class="p-4 font-bold">الرقم القومي</th>
                                        <th class="p-4 font-bold">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="servantsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Page: Attendance -->
                    <div id="attendancePage" class="page-content hidden-view">
                         <h1 class="h1 mb-6">تسجيل حضور الأنشطة</h1>
                         <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label for="yearSelector" class="block mb-2 font-bold">اختر السنة:</label>
                                    <select id="yearSelector" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                </div>
                                <div>
                                    <label for="monthSelector" class="block mb-2 font-bold">اختر الشهر:</label>
                                    <select id="monthSelector" class="w-full p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600" disabled></select>
                                </div>
                            </div>
                            <div id="fridaysGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-6"></div>
                            <div id="activityButtons" class="hidden-view grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6"></div>
                            <div id="attendanceListContainer" class="hidden-view mt-6 border-t pt-6">
                                <h3 id="attendanceListTitle" class="h3 mb-4"></h3>
                                <div id="noActivitySection" class="mb-4 p-3 bg-yellow-100 dark:bg-yellow-800 border-r-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 rounded-md">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" id="noActivityCheck" class="ml-3 h-5 w-5 rounded text-cyan-600 focus:ring-cyan-500">
                                        <span id="noActivityLabel"></span>
                                    </label>
                                    <textarea id="noActivityReason" placeholder="اكتب السبب أو الملاحظة هنا..." class="w-full p-2 mt-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 hidden"></textarea>
                                </div>
                                <div id="servantsChecklist" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2"></div>
                                <button id="saveActivityAttendanceBtn" class="mt-6 w-full text-white font-bold py-3 px-5 rounded-lg shadow-md hover:shadow-lg transition-all" style="background-color: var(--color-success);"><i class="fas fa-save mr-2"></i> حفظ الحضور</button>
                            </div>
                         </div>
                    </div>

                    <!-- Page: Reports -->
                    <div id="reportsPage" class="page-content hidden-view">
                        <h1 class="h1 mb-6">التقارير والإحصائيات</h1>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="border-b pb-4 mb-4">
                                <div id="reportTabs" class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                                    <button data-report-type="individual" class="report-tab active flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير فردي</button>
                                    <button data-report-type="comprehensive" class="report-tab flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير شامل</button>
                                    <button data-report-type="averages" class="report-tab flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300">تقرير المتوسطات</button>
                                    <button data-report-type="comparison" id="comparisonReportTab" class="report-tab flex-1 text-center py-2 px-4 border-b-2 font-medium text-lg transition-colors duration-300 hidden-view">مقارنة الخدمات</button>
                                </div>

                                <!-- Container for standard reports -->
                                <div id="standardReportsContainer">
                                    <div id="reportFilters" class="space-y-4">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                            <div id="serviceFilterContainer" class="hidden-view">
                                                <label for="reportServiceSelector" class="block mb-2 font-bold text-sm">اختر الخدمة:</label>
                                                <select id="reportServiceSelector" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                            </div>
                                            <div id="servantSelectorContainer" class="md:col-span-2">
                                                <label for="reportServantSelector" class="block mb-2 font-bold text-sm">اختر خادم:</label>
                                                <select id="reportServantSelector" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                            </div>
                                            <div>
                                                <label for="reportStartDate" class="block mb-2 font-bold text-sm">من تاريخ:</label>
                                                <input type="date" id="reportStartDate" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                            </div>
                                            <div>
                                                <label for="reportEndDate" class="block mb-2 font-bold text-sm">إلى تاريخ:</label>
                                                <input type="date" id="reportEndDate" class="w-full p-3 h-14 text-lg border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                            </div>
                                        </div>
                                        <button id="generateReportBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all">
                                            <i class="fas fa-cogs mr-2"></i> إنشاء التقرير
                                        </button>
                                    </div>
                                    <div id="reportOutput" class="hidden-view">
                                        <div id="reportContent" class="my-6"></div>
                                        <div id="exportButtons" class="flex justify-end gap-4 border-t pt-4">
                                            <button id="exportPngBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all"><i class="fas fa-file-image mr-2"></i> تصدير كصورة (PNG)</button>
                                            <button id="exportPdfBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all"><i class="fas fa-file-pdf mr-2"></i> تصدير كملف (PDF)</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Container for comparison report -->
                                <div id="comparisonReportContainer" class="hidden-view mt-4">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                        <div>
                                            <label for="comparisonServiceSelector1" class="block mb-2 font-bold text-sm">الخدمة الأولى:</label>
                                            <select id="comparisonServiceSelector1" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                        </div>
                                        <div>
                                            <label for="comparisonServiceSelector2" class="block mb-2 font-bold text-sm">الخدمة الثانية:</label>
                                            <select id="comparisonServiceSelector2" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"></select>
                                        </div>
                                    </div>
                                    <button id="generateComparisonBtn" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all">
                                        <i class="fas fa-balance-scale mr-2"></i> مقارنة
                                    </button>
                                    <div class="mt-6">
                                        <canvas id="comparisonChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- [RE-STYLED] Page: Activity Analysis with Filters -->
                    <div id="activityAnalysisPage" class="page-content hidden-view">
                        <h1 class="h1 mb-2">تحليل الغياب</h1>
                        <p class="text-gray-500 dark:text-gray-400 mb-6">استخدم الفلاتر أدناه لعرض تقارير الغياب المخصصة.</p>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <!-- Filters Section -->
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="analysisServiceFilter" class="block mb-2 font-bold text-sm text-gray-700 dark:text-gray-300">الخدمة:</label>
                                        <select id="analysisServiceFilter" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"></select>
                                    </div>
                                    <div>
                                        <label for="analysisYearFilter" class="block mb-2 font-bold text-sm text-gray-700 dark:text-gray-300">السنة:</label>
                                        <select id="analysisYearFilter" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"></select>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block font-bold text-sm text-gray-700 dark:text-gray-300">الأشهر (اختر شهر أو أكثر):</label>
                                        <div class="flex items-center">
                                            <input id="selectAllMonths" type="checkbox" class="w-4 h-4 text-cyan-600 bg-gray-100 border-gray-300 rounded focus:ring-cyan-500 ml-2 cursor-pointer">
                                            <label for="selectAllMonths" class="text-sm font-medium cursor-pointer">اختيار الكل</label>
                                        </div>
                                    </div>
                                    <div id="analysisMonthCheckboxes" class="grid grid-cols-[repeat(auto-fill,minmax(100px,1fr))] gap-3">
                                        <!-- Month checkboxes will be populated here -->
                                    </div>
                                </div>
                                <div class="flex flex-col md:flex-row items-center justify-between gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                                     <div class="flex items-center gap-3">
                                        <label class="font-bold text-sm whitespace-nowrap">عرض النتيجة كـ:</label>
                                        <div class="relative inline-block w-28 h-10 flex items-center justify-center">
                                            <input type="checkbox" id="analysisModeToggle" class="absolute w-full h-full opacity-0 z-10 cursor-pointer"/>
                                            <div class="w-full h-full bg-gray-300 dark:bg-gray-600 rounded-full shadow-inner"></div>
                                            <div id="analysisModeLabel" class="absolute text-white font-bold transition-all duration-300 ease-in-out"></div>
                                        </div>
                                    </div>
                                    <button id="generateAnalysisBtn" class="w-full md:w-auto bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2">
                                        <i class="fas fa-cogs"></i>
                                        <span>إنشاء التقرير</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Results Section -->
                            <div id="analysisResultContainer" class="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                                <!-- Analysis results will be injected here -->
                            </div>
                            
                            <!-- Export Button -->
                             <div id="exportAnalysisBtnContainer" class="flex justify-end mt-6 hidden-view">
                                <button id="exportAnalysisBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-file-image"></i>
                                    <span>تصدير كصورة</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="loginModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <div class="flex justify-between items-center pb-3">
                <h3 id="modalTitle" class="h2"></h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <form id="loginForm" class="mt-4">
                <p class="text-md mb-4">الرجاء إدخال كود الدخول المكون من 6 أرقام.</p>
                <input id="codeInput" type="number" placeholder="******" class="w-full px-4 py-3 text-lg text-center tracking-[1em] bg-gray-100 dark:bg-gray-700 border-2 rounded-lg focus:outline-none focus:border-cyan-500">
                <p id="errorMessage" class="text-red-500 text-sm mt-2 h-5"></p>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mt-4">دخــــول</button>
            </form>
        </div>
    </div>
    <div id="manualEntryModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-lg mx-auto rounded-xl shadow-lg z-50 p-8 max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center pb-3">
                <h3 id="manualEntryModalTitle" class="h2">إضافة خادم جديد</h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <form id="manualEntryForm" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="servantId">
                <input type="text" id="servantName" placeholder="الاسم بالكامل" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2">
                <input type="tel" id="servantMobile" placeholder="رقم الموبايل" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="date" id="servantDob" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-gray-700 dark:text-gray-300">
                <input type="text" id="servantNationalId" placeholder="الرقم القومي" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2">
                <input type="text" id="servantCurrentService" placeholder="الخدمة الحالية" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="text" id="servantJob" placeholder="الوظيفة" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <textarea id="servantAddress" placeholder="العنوان" required class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg md:col-span-2"></textarea>
                <input type="text" id="servantQualification" placeholder="المؤهل" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <input type="text" id="servantConfessionFather" placeholder="أب الاعتراف" class="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <div class="md:col-span-2">
                    <label class="block mb-2 text-sm font-medium">صورة الخادم (اختياري)</label>
                    <input type="file" id="servantImageFile" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                    <img id="imagePreview" src="" alt="Image Preview" class="mt-4 rounded-lg max-h-40 hidden"/>
                </div>
                <button type="submit" class="w-full text-white font-bold py-3 px-4 rounded-lg md:col-span-2" style="background-color: var(--color-success);">حفظ البيانات</button>
            </form>
        </div>
    </div>
    <div id="importModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <div class="flex justify-between items-center pb-3">
                <h3 class="h2">استيراد من Excel</h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <form id="importForm" class="mt-4">
                <p class="text-md mb-4">اختر ملف Excel (.xlsx, .xls). سيتم البدء من الصف الخامس.</p>
                <input type="file" id="excelFile" accept=".xlsx, .xls" required class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg mt-4">استيراد</button>
            </form>
        </div>
    </div>
    <div id="confirmModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <h3 id="confirmModalTitle" class="h3 mb-4">تأكيد الإجراء</h3>
            <p id="confirmModalBody" class="mb-6">هل أنت متأكد من أنك تريد المتابعة؟</p>
            <div class="flex justify-end gap-4">
                <button id="confirmModalCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
                <button id="confirmModalConfirmBtn" class="text-white font-bold py-2 px-6 rounded-lg" style="background-color: var(--color-danger);">تأكيد</button>
            </div>
        </div>
    </div>
    <div id="unifiedProfileModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-3xl mx-auto rounded-xl shadow-lg z-50 p-8 max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 id="unifiedProfileModalTitle" class="h2">الملف الشخصي الموحد</h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <div id="unifiedProfileModalBody">
                <!-- Profile content will be injected here -->
            </div>
        </div>
    </div>
    <div id="activityAttendeesModal" class="fixed inset-0 z-50 items-center justify-center hidden-view modal-backdrop">
        <div class="bg-white dark:bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 p-8">
            <div class="flex justify-between items-center pb-3">
                <h3 id="activityAttendeesModalTitle" class="h3"></h3>
                <button class="close-modal-btn cursor-pointer z-50 text-2xl" aria-label="إغلاق النافذة">&times;</button>
            </div>
            <div id="activityAttendeesModalBody" class="mt-4 max-h-60 overflow-y-auto">
                <!-- Attendee list will be injected here -->
            </div>
        </div>
    </div>
    <div id="messageBox" class="hidden fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-50"></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, setDoc, getDoc, getDocs, updateDoc, query, where, writeBatch, orderBy, serverTimestamp, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- THEME MANAGEMENT (RUNS IMMEDIATELY) ---
        const themeCheckbox = document.getElementById('theme-checkbox');
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                if(themeCheckbox) themeCheckbox.checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                if(themeCheckbox) themeCheckbox.checked = false;
            }
        }
        function toggleTheme() {
            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        }

        // ==================================================================
        // FILE: config.js (Application Configuration)
        // ==================================================================
        const services = [
            { name: "خدمة B.C", icon: '<i class="fas fa-book-bible"></i>', color: 'cyan' },
            { name: "خدمة KG", icon: '<i class="fas fa-child-reaching"></i>', color: 'lime' },
            { name: "خدمة أولى ابتدائي", icon: '<i class="fas fa-shapes"></i>', color: 'green' },
            { name: "خدمة ثانية ابتدائي", icon: '<i class="fas fa-pencil-ruler"></i>', color: 'yellow' },
            { name: "خدمة ثالثة ورابعة بنات", icon: '<i class="fas fa-female"></i>', color: 'pink' },
            { name: "خدمة ثالثة ورابعة أولاد", icon: '<i class="fas fa-male"></i>', color: 'indigo' },
            { name: "خدمة خامسة وسادسة بنات", icon: '<i class="fas fa-palette"></i>', color: 'red' },
            { name: "خدمة خامسة وسادسة أولاد", icon: '<i class="fas fa-running"></i>', color: 'purple' },
            { name: "خدمة الكورال والأنشطة", icon: '<i class="fas fa-music"></i>', color: 'teal' },
            { name: "خدمة وسائل الإيضاح", icon: '<i class="fas fa-desktop"></i>', color: 'orange' },
            { name: "الامين العام", icon: '<i class="fas fa-user-shield"></i>', color: 'blue' }
        ];
        
        const activities = [
            { key: 'visiting', name: 'الافتقاد', icon: 'fa-hand-holding-heart', color: 'rgba(249, 115, 22, 0.7)', borderColor: 'rgba(249, 115, 22, 1)' },
            { key: 'preparation', name: 'التحضير', icon: 'fa-book-open', color: 'rgba(234, 179, 8, 0.7)', borderColor: 'rgba(234, 179, 8, 1)' },
            { key: 'mass', name: 'القداس', icon: 'fa-cross', color: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(239, 68, 68, 1)' },
            { key: 'service', name: 'الخدمة', icon: 'fa-church', color: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)' },
            { key: 'explanation', name: 'الشرح', icon: 'fa-chalkboard-teacher', color: 'rgba(34, 197, 94, 0.7)', borderColor: 'rgba(34, 197, 94, 1)' }
        ];
        
        const CORRECT_CODE = '123456';
        const ADMIN_CODE = '999999';
        const activityMap = new Map(activities.map(a => [a.key, a]));


        // ==================================================================
        // FILE: app.js (Main Application Logic)
        // ==================================================================

        // --- GLOBAL STATE ---
        let currentServiceName = '';
        let db, auth, userId, servantsUnsubscribe = null, announcementsUnsubscribe = null;
        let servantsCache = [];
        let attendanceYearCache = {}; 
        let currentActivity = '';
        let selectedFriday = '';
        let currentReportType = 'individual';
        let isGeneralSecretaryMode = false;
        let allServantsCache = [];
        let allAttendanceCache = [];
        let isLocalMode = false;
        // Chart instances
        let reportChart1 = null, reportChart2 = null, homeChart = null;
        let adminChart = null, comparisonChart = null, profileChart = null, activityComparisonChart = null;
        
        let authReadyPromiseResolver;
        const authReady = new Promise(resolve => {
            authReadyPromiseResolver = resolve;
        });


        // --- DOM ELEMENTS CACHE ---
        let DOMElements = {};

        // --- LOCAL STORAGE HELPERS ---
        const getLocalData = (key) => JSON.parse(localStorage.getItem(key) || 'null');
        const setLocalData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const getLocalServants = (serviceName) => getLocalData(`church-app-servants-${serviceName}`) || [];
        const saveLocalServants = (servants, serviceName) => setLocalData(`church-app-servants-${serviceName}`, servants);
        const getLocalAttendance = (serviceName) => getLocalData(`church-app-attendance-${serviceName}`) || {};
        const saveLocalAttendance = (attendance, serviceName) => setLocalData(`church-app-attendance-${serviceName}`, attendance);

        // --- UI FUNCTIONS ---
        const showLoading = (isLoading) => {
            DOMElements.loadingOverlay.classList.toggle('flex', isLoading);
            DOMElements.loadingOverlay.classList.toggle('hidden-view', !isLoading);
        };
        const showMessage = (text, isError = false) => {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.classList.remove('hidden-view');
            setTimeout(() => messageBox.classList.add('hidden-view'), 3000);
        };
        const openModal = (modal) => modal.classList.replace('hidden-view', 'flex');
        const closeModal = (modal) => modal.classList.replace('flex', 'hidden-view');
        
        const showConfirm = (title, body, onConfirm) => {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalBody').innerHTML = body;
            openModal(DOMElements.confirmModal);
            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            const cancelBtn = document.getElementById('confirmModalCancelBtn');
            
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            const confirmHandler = () => { onConfirm(); closeModal(DOMElements.confirmModal); };
            const cancelHandler = () => closeModal(DOMElements.confirmModal);
            
            newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        };
        
        // --- CORE APP LOGIC ---
        async function initializeFirebase() {
            try {
                // --- Firebase Configuration ---
                const firebaseConfig = {
                  apiKey: "AIzaSyDqnWPGTAvIWakd0Wl14uuznrCy2oo8Iws",
                  authDomain: "church-service-app-4f180.firebaseapp.com",
                  projectId: "church-service-app-4f180",
                  storageBucket: "church-service-app-4f180.appspot.com",
                  messagingSenderId: "431475695196",
                  appId: "1:431475695196:web:4bd4389448eb94804e1099"
                };
                // -----------------------------

                isLocalMode = false;
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                try {
                    await enableIndexedDbPersistence(db);
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn('Firestore persistence failed: multiple tabs open.');
                    } else if (err.code == 'unimplemented') {
                        console.warn('Firestore persistence not available in this browser.');
                    }
                }

                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authReadyPromiseResolver(); 
                    } else {
                        try {
                           await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Sign-in failed:", error);
                            showMessage("فشل الاتصال بقاعدة البيانات", true);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("فشل تهيئة النظام. سيتم التشغيل في الوضع المحلي.", true);
                isLocalMode = true;
                userId = 'localUser';
            }
        }
        
        function populateServices() {
            DOMElements.servicesGrid.innerHTML = '';
            services.forEach(service => {
                const card = document.createElement('div');
                card.className = `service-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-2xl hover:-translate-y-1 transform transition-all duration-300 cursor-pointer flex flex-col items-center text-center border-2 border-transparent hover:ring-4 hover:ring-offset-2 hover:ring-${service.color}-400 dark:hover:ring-offset-gray-900`;
                card.dataset.serviceName = service.name;
                card.innerHTML = `<div class="text-5xl mb-4 text-${service.color}-500">${service.icon}</div><h3 class="h3">${service.name}</h3>`;
                DOMElements.servicesGrid.appendChild(card);
            });
        }

        async function showDashboard() {
            await authReady;
            DOMElements.loginOrServicesView.classList.add('hidden-view');
            DOMElements.mainDashboard.classList.remove('hidden-view');
            document.getElementById('sidebarServiceName').textContent = currentServiceName;
            
            DOMElements.sidebarLinks.querySelector('[data-page="servantsPage"]').classList.toggle('hidden-view', isGeneralSecretaryMode);
            DOMElements.sidebarLinks.querySelector('[data-page="attendancePage"]').classList.toggle('hidden-view', isGeneralSecretaryMode);
            DOMElements.activityAnalysisLink.classList.toggle('hidden-view', !isGeneralSecretaryMode);
            DOMElements.followUpLink.classList.toggle('hidden-view', !isGeneralSecretaryMode);
            
            showLoading(true);
            if (isGeneralSecretaryMode) {
                document.getElementById('sidebarServiceName').textContent = "عرض شامل (الامين العام)";
                populateAnnouncementTargetSelector();
                await loadAllServicesData();
                listenForAnnouncements();
                switchPage('homePage');
            } else {
                await loadServants();
                listenForAnnouncements();
                switchPage('homePage');
            }
            showLoading(false);
        }

        function returnToMainMenu() {
            DOMElements.mainDashboard.classList.add('hidden-view');
            DOMElements.loginOrServicesView.classList.remove('hidden-view');
            document.getElementById('sidebarServiceName').textContent = '';
            currentServiceName = '';
            if (servantsUnsubscribe) servantsUnsubscribe();
            if (announcementsUnsubscribe) announcementsUnsubscribe();
            servantsCache = [];
            attendanceYearCache = {};
            isGeneralSecretaryMode = false;
            allServantsCache = [];
            allAttendanceCache = [];
            DOMElements.sidebarLinks.querySelector('[data-page="servantsPage"]').classList.remove('hidden-view');
            DOMElements.sidebarLinks.querySelector('[data-page="attendancePage"]').classList.remove('hidden-view');
            DOMElements.activityAnalysisLink.classList.add('hidden-view');
            DOMElements.followUpLink.classList.add('hidden-view');
        }
        
        async function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden-view'));
            document.getElementById(pageId).classList.remove('hidden-view');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const activeLink = DOMElements.sidebarLinks.querySelector(`.sidebar-link[data-page="${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                DOMElements.mobilePageTitle.textContent = activeLink.innerText;
            }

            if (window.innerWidth < 768) {
                DOMElements.sidebar.classList.add('translate-x-full');
                DOMElements.sidebarOverlay.classList.add('hidden');
            }
            
            if (pageId === 'homePage') updateHomePageDashboard();
            if (pageId === 'followUpPage') updateFollowUpPage();
            if (pageId === 'servantsPage') displayUpcomingBirthdays();
            if (pageId === 'attendancePage' && !isGeneralSecretaryMode) loadAttendancePage();
            if (pageId === 'reportsPage') loadReportsPage();
            if (pageId === 'activityAnalysisPage') initializeActivityAnalysisPage();
        }

        // --- DATA FETCHING ---
        async function fetchData(collectionName, serviceName) {
            await authReady;
            if (isLocalMode) {
                return getLocalData(`church-app-${collectionName}-${serviceName}`) || (collectionName === 'attendance' ? {} : []);
            }
            try {
                const colRef = collection(db, 'services', serviceName, collectionName);
                const snapshot = await getDocs(colRef);
                if (collectionName === 'attendance') {
                    const attendanceData = {};
                    snapshot.docs.forEach(doc => {
                        attendanceData[doc.id] = doc.data();
                    });
                    return attendanceData;
                }
                return snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            } catch (error) {
                console.error(`Error fetching ${collectionName} for ${serviceName}:`, error);
                showMessage(`خطأ في تحميل بيانات ${collectionName}.`, true);
                return collectionName === 'attendance' ? {} : [];
            }
        }

        function loadServants() {
            return new Promise(async (resolve) => {
                await authReady;
                if (isLocalMode) {
                    servantsCache = getLocalServants(currentServiceName);
                    servantsCache.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                    renderServantsTable(servantsCache);
                    populateReportServantSelector();
                    return resolve();
                }
                if (!userId || !currentServiceName) return resolve();
                const servantsCol = collection(db, 'services', currentServiceName, 'servants');
                if (servantsUnsubscribe) servantsUnsubscribe();
                servantsUnsubscribe = onSnapshot(servantsCol, (snapshot) => {
                    servantsCache = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    servantsCache.sort((a, b) => a.name.localeCompare(b.name, 'ar'));
                    renderServantsTable(servantsCache);
                    populateReportServantSelector();
                    updateHomePageDashboard();
                    resolve();
                }, (error) => {
                    console.error("Error loading servants:", error);
                    showMessage("خطأ في تحميل بيانات الخدام.", true);
                    resolve();
                });
            });
        }
        
        async function loadAttendanceForYear(year) {
            await authReady;
            if (isLocalMode) {
                attendanceYearCache = getLocalAttendance(currentServiceName);
                return;
            }
            try {
                const attendanceCol = collection(db, 'services', currentServiceName, 'attendance');
                const q = query(attendanceCol, where('year', '==', Number(year)));
                const snapshot = await getDocs(q);
                attendanceYearCache = {};
                snapshot.docs.forEach(doc => {
                    attendanceYearCache[doc.id] = doc.data();
                });
            } catch (error) {
                console.error(`Error loading attendance for year ${year}:`, error);
                showMessage(`فشل تحميل بيانات الحضور لسنة ${year}.`, true);
                attendanceYearCache = {};
            }
        }
        
        async function loadAllServicesData() {
            await authReady;
            showLoading(true);
            allServantsCache = [];
            allAttendanceCache = [];
            const servicesToFetch = services.filter(s => s.name !== 'الامين العام');
            
            for (const service of servicesToFetch) {
                const serviceName = service.name;
                const [serviceServants, serviceAttendance] = await Promise.all([
                    fetchData('servants', serviceName),
                    fetchData('attendance', serviceName)
                ]);
                const attendanceArray = Object.entries(serviceAttendance).map(([date, data]) => ({ date, ...data, serviceName }));
                serviceServants.forEach(s => s.serviceName = serviceName);
                
                allServantsCache.push(...serviceServants);
                allAttendanceCache.push(...attendanceArray);

                renderAdminServantsTable(allServantsCache.sort((a, b) => a.name.localeCompare(b.name, 'ar')));
                updateAdminDashboard();
            }
            
            showLoading(false);
        }


        // --- SERVANTS FUNCTIONS ---
        function renderServantsTable(servantsToRender) {
            DOMElements.serviceColumnHeader.classList.toggle('hidden-view', !isGeneralSecretaryMode);
            DOMElements.servantsTableBody.innerHTML = '';
            if (!servantsToRender || servantsToRender.length === 0) {
                 DOMElements.servantsTableBody.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-gray-500">لا يوجد خدام لعرضهم.</td></tr>`;
                 return;
            }
            servantsToRender.forEach(servant => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50';
                const imageUrl = servant.imageUrl || 'https://placehold.co/60x60/E2E8F0/4A5568?text=?';
                const val = (data) => data || 'غير متوفر';
                row.innerHTML = `
                    <td class="p-4"><img src="${imageUrl}" alt="صورة ${val(servant.name)}" class="w-14 h-14 rounded-full object-cover" loading="lazy"></td>
                    <td class="p-4 font-semibold">${val(servant.name)}</td>
                    ${isGeneralSecretaryMode ? `<td class="p-4">${val(servant.serviceName)}</td>` : ''}
                    <td class="p-4">${val(servant.mobile)}</td>
                    <td class="p-4">${val(servant.dob)}</td>
                    <td class="p-4">${val(servant.nationalId)}</td>
                    <td class="p-4 space-x-2 whitespace-nowrap">
                        <button class="text-blue-500 hover:text-blue-700 edit-btn" data-id="${servant.id}" aria-label="تعديل ${val(servant.name)}"><i class="fas fa-edit"></i> تعديل</button>
                        <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${servant.id}" aria-label="حذف ${val(servant.name)}"><i class="fas fa-trash"></i> حذف</button>
                    </td>`;
                DOMElements.servantsTableBody.appendChild(row);
            });
        }
        
        function displayUpcomingBirthdays() {
            const container = document.getElementById('birthdayAlertsContainer');
            container.innerHTML = ''; 
            const sourceServants = isGeneralSecretaryMode ? allServantsCache : servantsCache;
            if (!sourceServants || sourceServants.length === 0) return;

            const upcoming = getUpcomingBirthdays(sourceServants, 5); // Get up to 5

            if (upcoming.length > 0) {
                let alertHTML = `<div class="p-4 bg-cyan-100 dark:bg-cyan-900 border-r-4 border-cyan-500 rounded-lg text-cyan-800 dark:text-cyan-200"><div class="flex items-center"><i class="fas fa-birthday-cake text-2xl ml-4"></i><div><h4 class="font-bold">أعياد ميلاد قادمة!</h4><ul class="list-disc list-inside mt-2">`;
                upcoming.forEach(person => {
                    const dayText = person.daysUntil === 0 ? 'اليوم!' : `بعد ${person.daysUntil} يوم`;
                    const serviceText = isGeneralSecretaryMode ? ` (${person.serviceName})` : '';
                    alertHTML += `<li><strong>${person.name}</strong>${serviceText} - ${person.date} (${dayText})</li>`;
                });
                alertHTML += `</ul></div></div></div>`;
                container.innerHTML = alertHTML;
            }
        }
        
        async function handleServantFormSubmit(e) {
            e.preventDefault();
            const servantId = DOMElements.manualEntryForm.querySelector('#servantId').value;
            let servantData = {
                name: DOMElements.manualEntryForm.querySelector('#servantName').value,
                mobile: DOMElements.manualEntryForm.querySelector('#servantMobile').value,
                dob: DOMElements.manualEntryForm.querySelector('#servantDob').value,
                nationalId: DOMElements.manualEntryForm.querySelector('#servantNationalId').value,
                currentService: DOMElements.manualEntryForm.querySelector('#servantCurrentService').value,
                address: DOMElements.manualEntryForm.querySelector('#servantAddress').value,
                qualification: DOMElements.manualEntryForm.querySelector('#servantQualification').value,
                job: DOMElements.manualEntryForm.querySelector('#servantJob').value,
                confessionFather: DOMElements.manualEntryForm.querySelector('#servantConfessionFather').value,
                imageUrl: DOMElements.imagePreview.src
            };
            
            showLoading(true);
            if (servantId) {
                await updateServant(servantId, servantData);
            } else {
                await addServant(servantData);
            }
            showLoading(false);
            closeModal(DOMElements.manualEntryModal);
        }

        async function addServant(servantData) {
            await authReady;
            if (isLocalMode) {
                const servants = getLocalServants(currentServiceName);
                servantData.id = `local-${Date.now()}`;
                servants.push(servantData);
                saveLocalServants(servants, currentServiceName);
                await loadServants();
                showMessage("تم إضافة الخادم بنجاح (محلياً)!");
                return;
            }
            try {
                const servantsCol = collection(db, 'services', currentServiceName, 'servants');
                await addDoc(servantsCol, servantData);
                showMessage("تم إضافة الخادم بنجاح!");
            } catch (error) {
                console.error("Error adding servant:", error);
                showMessage("فشل إضافة الخادم. الرجاء المحاولة مرة أخرى.", true);
            }
        }
        
        async function updateServant(servantId, servantData) {
            await authReady;
            if (isLocalMode) {
                let servants = getLocalServants(currentServiceName);
                const servantIndex = servants.findIndex(s => s.id === servantId);
                if (servantIndex > -1) {
                    servants[servantIndex] = { ...servants[servantIndex], ...servantData };
                    saveLocalServants(servants, currentServiceName);
                    await loadServants();
                    showMessage("تم تحديث بيانات الخادم (محلياً)!");
                }
                return;
            }
            try {
                const servantDocRef = doc(db, 'services', currentServiceName, 'servants', servantId);
                await updateDoc(servantDocRef, servantData);
                showMessage("تم تحديث بيانات الخادم بنجاح!");
            } catch (error) {
                console.error("Error updating servant:", error);
                showMessage("فشل تحديث بيانات الخادم.", true);
            }
        }

        async function deleteServant(servantId) {
            await authReady;
            showConfirm('تأكيد الحذف', 'هل أنت متأكد من حذف هذا الخادم؟ سيتم حذف جميع بياناته بشكل نهائي.', async () => {
                showLoading(true);
                if (isLocalMode) {
                    let servants = getLocalServants(currentServiceName);
                    servants = servants.filter(s => s.id !== servantId);
                    saveLocalServants(servants, currentServiceName);
                    await loadServants();
                    showLoading(false);
                    showMessage("تم حذف الخادم (محلياً).");
                    return;
                }
                try {
                    const servantDocRef = doc(db, 'services', currentServiceName, 'servants', servantId);
                    await deleteDoc(servantDocRef);
                    showMessage("تم حذف الخادم بنجاح.");
                } catch (error) {
                    console.error("Error deleting servant:", error);
                    showMessage("فشل حذف الخادم.", true);
                } finally {
                    showLoading(false);
                }
            });
        }
        
        function handleEditClick(servantId) {
            const servant = servantsCache.find(s => s.id === servantId);
            if (!servant) return;

            const form = DOMElements.manualEntryForm;
            form.reset(); 
            
            DOMElements.manualEntryModalTitle.textContent = 'تعديل بيانات خادم';
            form.querySelector('#servantId').value = servant.id || '';
            form.querySelector('#servantName').value = servant.name || '';
            form.querySelector('#servantMobile').value = servant.mobile || '';
            form.querySelector('#servantDob').value = servant.dob || '';
            form.querySelector('#servantNationalId').value = servant.nationalId || '';
            form.querySelector('#servantCurrentService').value = servant.currentService || '';
            form.querySelector('#servantAddress').value = servant.address || '';
            form.querySelector('#servantQualification').value = servant.qualification || '';
            form.querySelector('#servantJob').value = servant.job || '';
            form.querySelector('#servantConfessionFather').value = servant.confessionFather || '';

            if (servant.imageUrl) {
                DOMElements.imagePreview.src = servant.imageUrl;
                DOMElements.imagePreview.classList.remove('hidden');
            } else {
                DOMElements.imagePreview.src = '';
                DOMElements.imagePreview.classList.add('hidden');
            }

            openModal(DOMElements.manualEntryModal);
        }

        // --- ATTENDANCE FUNCTIONS ---
        function loadAttendancePage() {
            DOMElements.yearSelector.innerHTML = '<option value="">اختر سنة</option>';
            for (let i = 2030; i >= 2025; i--) {
                DOMElements.yearSelector.innerHTML += `<option value="${i}">${i}</option>`;
            }
            DOMElements.monthSelector.innerHTML = '<option value="">اختر شهر</option>';
            DOMElements.monthSelector.disabled = true;
            DOMElements.fridaysGrid.innerHTML = '';
            DOMElements.activityButtons.classList.add('hidden-view');
            DOMElements.attendanceListContainer.classList.add('hidden-view');
        }

        function populateMonths(year) {
            DOMElements.monthSelector.innerHTML = '<option value="">اختر شهر</option>';
            const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];
            months.forEach((month, index) => {
                DOMElements.monthSelector.innerHTML += `<option value="${index}">${month}</option>`;
            });
            DOMElements.monthSelector.disabled = false;
        }

        function populateFridaysGrid(year, month) {
            DOMElements.fridaysGrid.innerHTML = '';
            const fridays = [];
            const date = new Date(year, month, 1);
            while (date.getMonth() === month) {
                if (date.getDay() === 5) { // 5 is for Friday
                    fridays.push(new Date(date.getTime()));
                }
                date.setDate(date.getDate() + 1);
            }
            
            for (const friday of fridays) {
                const y = friday.getFullYear();
                const m = (friday.getMonth() + 1).toString().padStart(2, '0');
                const d = friday.getDate().toString().padStart(2, '0');
                const dateString = `${y}-${m}-${d}`;
                
                const day = friday.getDate();
                let buttonHTML = `<button data-date="${dateString}" class="friday-btn h-20 flex flex-col items-center justify-between p-2 rounded-lg bg-cyan-500 text-white font-bold transition-all duration-200 shadow hover:shadow-lg hover:bg-cyan-600">
                    <span class="flex-grow flex items-center text-2xl font-bold">${day}</span>`;
                
                const dayData = attendanceYearCache[dateString] || {};
                
                let dotsHTML = '<div class="flex justify-center items-center gap-1.5">';
                activities.forEach(act => {
                    const activityData = dayData[act.key];
                    const color = activityData && activityData.attendees && activityData.attendees.length > 0 ? act.borderColor : (activityData && activityData.note ? '#facc15' : (activityData ? '#f87171' : '#d1d5db'));
                    dotsHTML += `<span style="background-color: ${color};" class="block w-3.5 h-3.5 rounded-full border-2 border-white/70 shadow-sm"></span>`;
                });
                dotsHTML += '</div>';

                buttonHTML += dotsHTML;
                buttonHTML += `</button>`;
                DOMElements.fridaysGrid.insertAdjacentHTML('beforeend', buttonHTML);
            }
        }
        
        async function updateActivityButtonsStatus(date) {
            const dayData = attendanceYearCache[date] || {};

            DOMElements.activityButtons.innerHTML = '';
            activities.forEach(act => {
                const activityData = dayData[act.key];
                let statusIcon = '', statusText = '';
                if (activityData) {
                    if (activityData.note !== null && activityData.note !== undefined) {
                        statusIcon = `<i class="fas fa-exclamation-circle text-yellow-300 ml-2"></i>`;
                        statusText = `<span class="text-xs font-normal">ملغى</span>`;
                    } else if (activityData.attendees) {
                        statusIcon = `<i class="fas fa-check-circle text-green-300 ml-2"></i>`;
                        statusText = `<span class="text-xs font-normal">${activityData.attendees.length}/${servantsCache.length} حاضر</span>`;
                    }
                }
                DOMElements.activityButtons.innerHTML += `<button data-activity="${act.key}" class="activity-btn p-3 rounded-lg text-white font-bold transition-all duration-200 shadow hover:shadow-lg flex flex-col items-center justify-center" style="background-color: ${act.borderColor}"><div class="flex items-center"><i class="fas ${act.icon} mr-2"></i><span>${act.name}</span></div><div class="mt-1 h-4">${statusIcon}${statusText}</div></button>`;
            });
            DOMElements.activityButtons.classList.remove('hidden-view');
        }

        async function showActivityChecklist(activityKey, date) {
            currentActivity = activityKey;
            const activity = activityMap.get(activityKey);
            document.querySelectorAll('.activity-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.activity-btn[data-activity="${activityKey}"]`).classList.add('active');
            
            const [year, month, day] = date.split('-').map(Number);
            const displayDate = new Date(year, month - 1, day);
            const formattedDate = displayDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            DOMElements.attendanceListTitle.textContent = `تسجيل حضور: ${activity.name} - ${formattedDate}`;
            DOMElements.servantsChecklist.innerHTML = '';
            
            DOMElements.noActivityCheck.checked = false;
            DOMElements.noActivityReason.value = '';
            DOMElements.noActivityReason.classList.add('hidden');
            DOMElements.noActivityLabel.textContent = `لا يوجد ${activity.name} لهذا اليوم`;
            DOMElements.servantsChecklist.classList.remove('hidden');

            const dayData = attendanceYearCache[date] || {};
            const activityData = dayData[activityKey] || {};
            
            const attendees = activityData.attendees || [];
            if (activityData.note !== undefined && activityData.note !== null) {
                DOMElements.noActivityCheck.checked = true;
                DOMElements.noActivityReason.value = activityData.note;
                DOMElements.noActivityReason.classList.remove('hidden');
                DOMElements.servantsChecklist.classList.add('hidden');
            }

            servantsCache.forEach(servant => {
                const isChecked = attendees.includes(servant.id);
                const a_id = `${activityKey}-${servant.id}`;
                DOMElements.servantsChecklist.innerHTML += `<div class="flex items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700"><input id="${a_id}" type="checkbox" data-servant-id="${servant.id}" class="w-5 h-5 ml-3 rounded text-cyan-600 focus:ring-cyan-500" ${isChecked ? 'checked' : ''}><label for="${a_id}" class="cursor-pointer">${servant.name}</label></div>`;
            });
            DOMElements.attendanceListContainer.classList.remove('hidden-view');
        }
        
        async function saveActivityAttendance() {
            await authReady;
            if (!selectedFriday || !currentActivity) return showMessage("الرجاء اختيار اليوم والنشاط أولاً.", true);
            
            const [year, month, day] = selectedFriday.split('-').map(Number);
            
            const activityUpdate = { year: Number(year) };
            if (DOMElements.noActivityCheck.checked) {
                activityUpdate.attendees = [];
                activityUpdate.note = DOMElements.noActivityReason.value || 'تم الإلغاء';
            } else {
                const attendees = Array.from(DOMElements.servantsChecklist.querySelectorAll('input[type="checkbox"]:checked'))
                                       .map(checkbox => checkbox.dataset.servantId);
                activityUpdate.attendees = attendees;
                activityUpdate.note = null;
            }

            const dayData = attendanceYearCache[selectedFriday] || { year: Number(year) };
            dayData[currentActivity] = activityUpdate;
            
            if (isLocalMode) {
                attendanceYearCache[selectedFriday] = dayData;
                saveLocalAttendance(attendanceYearCache, currentServiceName);
            } else {
                try {
                    const dayDocRef = doc(db, 'services', currentServiceName, 'attendance', selectedFriday);
                    await setDoc(dayDocRef, dayData); 
                    attendanceYearCache[selectedFriday] = dayData;
                } catch (error) {
                    console.error("Error saving attendance:", error);
                    showMessage("فشل حفظ الحضور.", true);
                    return;
                }
            }
            
            showMessage(`تم حفظ الحضور بنجاح.`);
            DOMElements.attendanceListContainer.classList.add('hidden-view');
            await updateActivityButtonsStatus(selectedFriday);
            
            const currentYear = parseInt(DOMElements.yearSelector.value);
            const currentMonth = parseInt(DOMElements.monthSelector.value);
            if (!isNaN(currentYear) && !isNaN(currentMonth)) {
                populateFridaysGrid(currentYear, currentMonth);
            }
        }

        // --- REPORTS FUNCTIONS ---
        function getPercentageColor(percentage) {
            if (percentage >= 75) return 'bg-green-500';
            if (percentage >= 50) return 'bg-yellow-500';
            return 'bg-red-500';
        }

        function getPercentageTextColor(percentage) {
            if (percentage >= 75) return 'text-green-600 dark:text-green-400';
            if (percentage >= 50) return 'text-yellow-600 dark:text-yellow-400';
            if (percentage > 0) return 'text-red-600 dark:text-red-400';
            return 'text-gray-500';
        }
        
        function getPercentageBGColor(percentage) {
            if (percentage >= 75) return 'bg-green-100 dark:bg-green-900';
            if (percentage >= 50) return 'bg-yellow-100 dark:bg-yellow-900';
            return 'bg-red-100 dark:bg-red-900';
        }

        async function loadReportsPage() {
            await authReady;
            DOMElements.reportOutput.classList.add('hidden-view');
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            DOMElements.reportStartDate.value = firstDayOfMonth.toISOString().split('T')[0];
            DOMElements.reportEndDate.value = today.toISOString().split('T')[0];
            
            document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-report-type="individual"]').classList.add('active');
            currentReportType = 'individual';
            
            DOMElements.standardReportsContainer.classList.remove('hidden-view');
            DOMElements.comparisonReportContainer.classList.add('hidden-view');

            DOMElements.servantSelectorContainer.classList.remove('hidden-view');
            
            DOMElements.serviceFilterContainer.classList.toggle('hidden-view', !isGeneralSecretaryMode);
            DOMElements.comparisonReportTab.classList.toggle('hidden-view', !isGeneralSecretaryMode);

            if (isGeneralSecretaryMode) {
                populateServiceFilter();
                populateComparisonSelectors();
                 if(allServantsCache.length === 0) await loadAllServicesData();
            } else {
                const attendanceData = await fetchData('attendance', currentServiceName);
                allAttendanceCache = Object.entries(attendanceData).map(([date, data]) => ({ date, ...data }));
            }
            populateReportServantSelector();
        }
        
        function populateServiceFilter() {
            DOMElements.reportServiceSelector.innerHTML = '<option value="all">كل الخدمات</option>';
            const serviceNames = services.filter(s => s.name !== 'الامين العام').map(s => s.name);
            serviceNames.sort((a,b) => a.localeCompare(b,'ar')).forEach(name => {
                DOMElements.reportServiceSelector.innerHTML += `<option value="${name}">${name}</option>`;
            });
        }
        
        function populateReportServantSelector(filteredServants) {
            const sourceServants = filteredServants || (isGeneralSecretaryMode ? allServantsCache : servantsCache);
            DOMElements.reportServantSelector.innerHTML = '<option value="">-- اختر --</option>';
            DOMElements.reportServantSelector.innerHTML += '<option value="all">-- كل الخدام --</option>';
            sourceServants.forEach(servant => {
                const displayName = isGeneralSecretaryMode && servant.serviceName ? `${servant.name} (${servant.serviceName})` : servant.name;
                DOMElements.reportServantSelector.innerHTML += `<option value="${servant.id}">${displayName}</option>`;
            });
        }

        function triggerReportGeneration() {
            const startDate = DOMElements.reportStartDate.value;
            const endDate = DOMElements.reportEndDate.value;
            if (!startDate || !endDate || startDate > endDate) {
                showMessage("الرجاء تحديد فترة زمنية صحيحة.", true);
                return;
            }

            let sourceAttendance = isGeneralSecretaryMode ? allAttendanceCache : allAttendanceCache;
            let sourceServants = isGeneralSecretaryMode ? allServantsCache : servantsCache;

            if (isGeneralSecretaryMode) {
                const selectedService = DOMElements.reportServiceSelector.value;
                if (selectedService !== 'all') {
                    sourceAttendance = allAttendanceCache.filter(item => item.serviceName === selectedService);
                    sourceServants = allServantsCache.filter(servant => servant.serviceName === selectedService);
                }
            }

            const filteredAttendance = sourceAttendance.filter(item => item.date >= startDate && item.date <= endDate);

            if (currentReportType === 'individual') {
                const servantId = DOMElements.reportServantSelector.value;
                if (!servantId) return showMessage("الرجاء اختيار خادم لعرض التقرير.", true);
                if (servantId === 'all') displayAllServantsAverageReport(filteredAttendance, sourceServants);
                else displayIndividualReport(servantId, filteredAttendance, sourceServants);
            } else if (currentReportType === 'comprehensive') {
                generateComprehensiveReport(filteredAttendance, sourceServants);
            } else if (currentReportType === 'averages') {
                generateAveragesReport(filteredAttendance, sourceServants);
            }
        }
        
        function displayIndividualReport(servantId, data, servants) {
            const servant = servants.find(s => s.id === servantId);
            if (!servant) return;

            DOMElements.reportContent.innerHTML = ''; 
            const reportData = { total: {}, attended: {} };
            activities.forEach(act => { reportData.total[act.key] = 0; reportData.attended[act.key] = 0; });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && (activityData.note === null || activityData.note === undefined)) {
                        reportData.total[activity.key]++;
                        if (activityData.attendees && activityData.attendees.includes(servantId)) {
                            reportData.attended[activity.key]++;
                        }
                    }
                });
            });

            let reportHTML = `<h3 class="h3 mb-4">تقرير الحضور لـ: ${servant.name}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4">`;
            let percentages = [];
            activities.forEach(activity => {
                const total = reportData.total[activity.key];
                const attended = reportData.attended[activity.key];
                const percentage = total > 0 ? Math.round((attended / total) * 100) : 0;
                percentages.push(percentage);
                reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(percentage)}"><div class="font-bold text-lg">${activity.name}</div><div class="text-3xl font-bold my-2">${percentage}%</div><div class="text-sm text-gray-500 dark:text-gray-400">(${attended} من ${total})</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(percentage)} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
            });

            const overallAverage = percentages.length > 0 ? Math.round(percentages.reduce((a, b) => a + b, 0) / percentages.length) : 0;
            reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(overallAverage)} col-span-2 md:col-span-1"><div class="font-bold text-lg">المتوسط العام</div><div class="text-3xl font-bold my-2">${overallAverage}%</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(overallAverage)} h-2.5 rounded-full" style="width: ${overallAverage}%"></div></div></div>`;
            reportHTML += '</div>';
            DOMElements.reportContent.innerHTML = reportHTML;
            DOMElements.reportOutput.classList.remove('hidden-view');
        }

        function generateComprehensiveReport(data, servants) {
            DOMElements.reportContent.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'w-full text-right min-w-[1000px]';
            let tableHTML = `<thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="p-3 font-bold">اسم الخادم</th>`;
            activities.forEach(act => { tableHTML += `<th class="p-3 font-bold text-center">${act.name}</th>`; });
            tableHTML += `<th class="p-3 font-bold text-center">المتوسط العام</th></tr></thead><tbody>`;

            servants.forEach(servant => {
                tableHTML += `<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50"><td class="p-3 font-semibold">${servant.name}</td>`;
                let percentages = [];
                activities.forEach(act => {
                    let attended = 0, meetings = 0;
                    data.forEach(day => {
                        if (day[act.key] && (day[act.key].note === null || day[act.key].note === undefined)) {
                            meetings++;
                            if (day[act.key].attendees.includes(servant.id)) attended++;
                        }
                    });
                    const percentage = meetings > 0 ? Math.round((attended / meetings) * 100) : 0;
                    percentages.push(percentage);
                    tableHTML += `<td class="p-3 text-center font-bold ${getPercentageTextColor(percentage)}">${percentage}% <span class="text-xs text-gray-500">(${attended}/${meetings})</span></td>`;
                });
                const overallPercentage = percentages.length > 0 ? Math.round(percentages.reduce((a,b) => a + b, 0) / percentages.length) : 0;
                tableHTML += `<td class="p-3 text-center font-extrabold text-cyan-600 dark:text-cyan-400">${overallPercentage}%</td></tr>`;
            });
            tableHTML += `</tbody>`;
            table.innerHTML = tableHTML;
            DOMElements.reportContent.appendChild(table);
            DOMElements.reportOutput.classList.remove('hidden-view');
        }
        
        function displayAllServantsAverageReport(data, servants) { 
            DOMElements.reportContent.innerHTML = '';
            let reportHTML = `<h3 class="h3 mb-4">متوسط الحضور لكل الأنشطة</h3>`;
            reportHTML += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4">';
            
            const activityTotals = {}, activityCounts = {};
            activities.forEach(act => { activityTotals[act.key] = 0; activityCounts[act.key] = 0; });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && (activityData.note === null || activityData.note === undefined)) {
                        activityTotals[activity.key] += activityData.attendees.length;
                        activityCounts[activity.key]++;
                    }
                });
            });

            const avgAttendancePercentages = activities.map(activity => {
                const totalAttendees = activityTotals[activity.key];
                const totalMeetings = activityCounts[activity.key];
                if (totalMeetings === 0 || servants.length === 0) return 0;
                return Math.round(((totalAttendees / totalMeetings) / servants.length) * 100);
            });
            
            let overallPercentages = [];
            activities.forEach((activity, index) => {
                const percentage = avgAttendancePercentages[index];
                overallPercentages.push(percentage);
                reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(percentage)}"><div class="font-bold text-lg">${activity.name}</div><div class="text-3xl font-bold my-2">${percentage}%</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(percentage)} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
            });

            const overallAverage = overallPercentages.length > 0 ? Math.round(overallPercentages.reduce((a, b) => a + b, 0) / overallPercentages.length) : 0;
            reportHTML += `<div class="text-center p-4 rounded-lg ${getPercentageBGColor(overallAverage)} col-span-2 md:col-span-1"><div class="font-bold text-lg">المتوسط العام</div><div class="text-3xl font-bold my-2">${overallAverage}%</div><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600 mt-2"><div class="${getPercentageColor(overallAverage)} h-2.5 rounded-full" style="width: ${overallAverage}%"></div></div></div>`;
            reportHTML += '</div>';
            DOMElements.reportContent.innerHTML = reportHTML;
            DOMElements.reportOutput.classList.remove('hidden-view');
        };
        
        function generateAveragesReport(data, servants) { 
            DOMElements.reportContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg shadow">
                        <h4 class="font-bold mb-2 text-center">متوسط نسبة الحضور لكل نشاط</h4>
                        <div class="relative h-80"><canvas id="reportAverageChartBar"></canvas></div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div id="topActivityCard" class="text-center p-4 rounded-lg bg-green-100 dark:bg-green-900"></div>
                        <div id="bottomActivityCard" class="text-center p-4 rounded-lg bg-red-100 dark:bg-red-900"></div>
                        <div class="col-span-2 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg shadow">
                             <h4 class="font-bold mb-2 text-center">توزيع الحضور</h4>
                            <div class="relative h-48"><canvas id="reportAverageChartDoughnut"></canvas></div>
                        </div>
                    </div>
                </div>
            `;

            const activityTotals = {};
            const activityCounts = {};
            activities.forEach(act => { 
                activityTotals[act.key] = 0; 
                activityCounts[act.key] = 0; 
            });

            data.forEach(day => {
                activities.forEach(activity => {
                    const activityData = day[activity.key];
                    if (activityData && (activityData.note === null || activityData.note === undefined)) {
                        activityTotals[activity.key] += activityData.attendees.length;
                        activityCounts[activity.key]++;
                    }
                });
            });

            const avgAttendance = activities.map(activity => {
                const totalAttendees = activityTotals[activity.key];
                const totalMeetings = activityCounts[activity.key];
                if (totalMeetings === 0 || servants.length === 0) return 0;
                return Math.round(((totalAttendees / totalMeetings) / servants.length) * 100);
            });

            if (reportChart1) reportChart1.destroy();
            if (reportChart2) reportChart2.destroy();

            const ctxBar = document.getElementById('reportAverageChartBar').getContext('2d');
            reportChart1 = new Chart(ctxBar, { 
                type: 'bar', 
                data: { 
                    labels: activities.map(a => a.name), 
                    datasets: [{ 
                        label: 'متوسط نسبة الحضور', 
                        data: avgAttendance, 
                        backgroundColor: activities.map(a => a.color),
                        borderColor: activities.map(a => a.borderColor),
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }, 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                } 
            });
            
            const totalAttendanceSum = Object.values(activityTotals).reduce((a, b) => a + b, 0);
            const doughnutData = totalAttendanceSum > 0 ? activities.map(a => activityTotals[a.key]) : activities.map(() => 1);
            const ctxDoughnut = document.getElementById('reportAverageChartDoughnut').getContext('2d');
            reportChart2 = new Chart(ctxDoughnut, {
                type: 'doughnut',
                data: {
                    labels: activities.map(a => a.name),
                    datasets: [{
                        label: 'توزيع الحضور',
                        data: doughnutData,
                        backgroundColor: activities.map(a => a.color),
                        borderColor: '#ffffff',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { padding: 10 } } }
                }
            });

            const activityWithPercentages = activities.map((act, i) => ({ name: act.name, percentage: avgAttendance[i] }));
            activityWithPercentages.sort((a,b) => b.percentage - a.percentage);
            const topActivity = activityWithPercentages[0];
            const bottomActivity = activityWithPercentages[activityWithPercentages.length - 1];
            
            document.getElementById('topActivityCard').innerHTML = `<div class="font-bold text-green-800 dark:text-green-200">الأعلى حضوراً</div><div class="text-3xl font-bold my-1 text-green-600">${topActivity.percentage}%</div><div class="text-sm text-gray-500">${topActivity.name}</div>`;
            document.getElementById('bottomActivityCard').innerHTML = `<div class="font-bold text-red-800 dark:text-red-200">الأقل حضوراً</div><div class="text-3xl font-bold my-1 text-red-600">${bottomActivity.percentage}%</div><div class="text-sm text-gray-500">${bottomActivity.name}</div>`;

            DOMElements.reportOutput.classList.remove('hidden-view');
        };

        // --- Backup and Restore Functions ---
        async function backupData() {
            await authReady;
            showLoading(true);
            try {
                const servants = isLocalMode ? getLocalServants(currentServiceName) : await fetchData('servants', currentServiceName);
                const attendance = isLocalMode ? getLocalAttendance(currentServiceName) : await fetchData('attendance', currentServiceName);
                
                const backupObject = {
                    serviceName: currentServiceName,
                    exportDate: new Date().toISOString(),
                    data: {
                        servants: servants,
                        attendance: attendance
                    }
                };

                const jsonString = JSON.stringify(backupObject, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${currentServiceName.replace(/\s/g, '_')}-${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage("تم إنشاء ملف النسخة الاحتياطية بنجاح.");
            } catch (error) {
                console.error("Backup failed:", error);
                showMessage("فشل إنشاء النسخة الاحتياطية.", true);
            } finally {
                showLoading(false);
            }
        }

        function restoreData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const backupObject = JSON.parse(event.target.result);
                        if (!backupObject.serviceName || !backupObject.data || !backupObject.data.servants || !backupObject.data.attendance) {
                            throw new Error("ملف غير صالح.");
                        }

                        if (backupObject.serviceName !== currentServiceName) {
                           return showMessage(`هذا الملف خاص بخدمة "${backupObject.serviceName}" وليس الخدمة الحالية.`, true);
                        }

                        const confirmationMessage = `
                            أنت على وشك استعادة البيانات لخدمة <strong>"${backupObject.serviceName}"</strong>.
                            <br><strong>تحذير:</strong> هذا الإجراء سيقوم بمسح جميع البيانات الحالية واستبدالها بالبيانات من الملف. هل أنت متأكد؟
                        `;

                        showConfirm("تأكيد الاستعادة", confirmationMessage, async () => {
                            await authReady;
                            showLoading(true);
                            const { servants, attendance } = backupObject.data;
                            if (isLocalMode) {
                                saveLocalServants(servants, currentServiceName);
                                saveLocalAttendance(attendance, currentServiceName);
                                await loadServants();
                                await loadAttendanceForYear(new Date().getFullYear());
                                showMessage("تم استعادة البيانات بنجاح!");
                            } else {
                                const servantsColRef = collection(db, 'services', currentServiceName, 'servants');
                                const attendanceColRef = collection(db, 'services', currentServiceName, 'attendance');

                                const deleteBatch = writeBatch(db);
                                const existingServants = await getDocs(servantsColRef);
                                existingServants.forEach(doc => deleteBatch.delete(doc.ref));
                                const existingAttendance = await getDocs(attendanceColRef);
                                existingAttendance.forEach(doc => deleteBatch.delete(doc.ref));
                                await deleteBatch.commit();

                                const idMap = {};
                                const addServantsBatch = writeBatch(db);
                                for (const servant of servants) {
                                    const oldId = servant.id;
                                    const { id, ...servantData } = servant;
                                    const newDocRef = doc(servantsColRef);
                                    idMap[oldId] = newDocRef.id;
                                    addServantsBatch.set(newDocRef, servantData);
                                }
                                await addServantsBatch.commit();

                                const addAttendanceBatch = writeBatch(db);
                                for (const [date, attendanceData] of Object.entries(attendance)) {
                                    const correctedData = { ...attendanceData };
                                    for (const activityKey in correctedData) {
                                        if (correctedData[activityKey] && Array.isArray(correctedData[activityKey].attendees)) {
                                            correctedData[activityKey].attendees = correctedData[activityKey].attendees
                                                .map(oldId => idMap[oldId])
                                                .filter(newId => newId); // Filter out any undefined IDs
                                        }
                                    }
                                    const newDocRef = doc(attendanceColRef, date);
                                    addAttendanceBatch.set(newDocRef, correctedData);
                                }
                                await addAttendanceBatch.commit();

                                showMessage("تم استعادة البيانات بنجاح!");
                            }
                            showLoading(false);
                        });

                    } catch (error) {
                        console.error("Restore failed:", error);
                        showMessage("فشل استعادة البيانات. تأكد من أن الملف صحيح.", true);
                        showLoading(false);
                    }
                };
                reader.readAsText(file);
            };
            fileInput.click();
        }

        function waitChartsRendered() {
            return new Promise(resolve => {
                const charts = [homeChart, adminChart, comparisonChart, reportChart1, reportChart2, profileChart].filter(Boolean);
                let pending = charts.length;
                if (pending === 0) {
                    resolve();
                    return;
                }
                charts.forEach(chart => {
                    if (!chart || !chart.animating || chart.animating.length === 0) {
                        if (--pending === 0) resolve();
                        return;
                    }
                    const originalOnComplete = chart.options.animation && chart.options.animation.onComplete;
                    chart.options.animation = {
                        ...(chart.options.animation || {}),
                        onComplete: () => {
                            if (originalOnComplete) originalOnComplete();
                            if (--pending === 0) resolve();
                        }
                    };
                });
            });
        }

        async function exportAsImage() {
            await waitChartsRendered();
            const reportContent = DOMElements.reportContent;
            html2canvas(reportContent, { 
                backgroundColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff',
                scale: 2,
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `report-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        async function exportAsPdf() {
            await waitChartsRendered();
            const { jsPDF } = window.jspdf;
            const reportContent = DOMElements.reportContent;
            
            html2canvas(reportContent, { 
                backgroundColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff',
                scale: 2,
                useCORS: true,
                width: reportContent.scrollWidth,
                height: reportContent.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                
                const orientation = imgWidth > imgHeight ? 'l' : 'p'; 
                
                const pdf = new jsPDF(orientation, 'px', [imgWidth, imgHeight]);
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`report-${new Date().toISOString().slice(0,10)}.pdf`);
            });
        }
        
        // --- HOME PAGE DASHBOARD ---
        function getUpcomingBirthdays(sourceServants, limit = 1) {
            const upcoming = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(today.getDate() + 30);

            if (!sourceServants || sourceServants.length === 0) return [];

            sourceServants.forEach(servant => {
                if (!servant.dob) return;
                const dobParts = servant.dob.split('-');
                if (dobParts.length < 3) return;
                const birthDate = new Date(parseInt(dobParts[0]), parseInt(dobParts[1]) - 1, parseInt(dobParts[2]));
                if (isNaN(birthDate.getTime())) return;
                
                let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                if (nextBirthday < today) {
                    nextBirthday.setFullYear(today.getFullYear() + 1);
                }

                const diffTime = nextBirthday - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays >= 0 && diffDays <= 30) {
                    if (!upcoming.some(b => b.name === servant.name)) {
                         upcoming.push({
                            name: servant.name,
                            serviceName: servant.serviceName,
                            date: nextBirthday.toLocaleDateString('ar-EG', { month: 'long', day: 'numeric' }),
                            daysUntil: diffDays
                        });
                    }
                }
            });
            
            return upcoming.sort((a, b) => a.daysUntil - b.daysUntil).slice(0, limit);
        }

        async function updateHomePageDashboard() {
            await authReady;
            DOMElements.serviceDashboardContainer.classList.toggle('hidden-view', isGeneralSecretaryMode);
            DOMElements.adminDashboardContainer.classList.toggle('hidden-view', !isGeneralSecretaryMode);

            if (isGeneralSecretaryMode) {
                renderAdminServantsTable(allServantsCache);
                updateAdminDashboard();
                
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = thirtyDaysAgo.toISOString().split('T')[0];
                const endDate = new Date().toISOString().split('T')[0];
                const filteredAttendance = allAttendanceCache.filter(item => item.date >= startDate && item.date <= endDate);
                
                const activityTotals = {}, activityCounts = {};
                activities.forEach(act => { activityTotals[act.key] = 0; activityCounts[act.key] = 0; });

                filteredAttendance.forEach(day => {
                    activities.forEach(activity => {
                        const activityData = day[activity.key];
                        if (activityData && (activityData.note === null || activityData.note === undefined)) {
                            const serviceServantCount = allServantsCache.filter(s => s.serviceName === day.serviceName).length;
                            if(serviceServantCount > 0) {
                                activityTotals[activity.key] += (activityData.attendees.length / serviceServantCount);
                                activityCounts[activity.key]++;
                            }
                        }
                    });
                });

                const avgAttendance = activities.map(activity => {
                    const totalPercentageSum = activityTotals[activity.key];
                    const totalMeetings = activityCounts[activity.key];
                    if (totalMeetings === 0) return 0;
                    return Math.round((totalPercentageSum / totalMeetings) * 100);
                });

                if (adminChart) adminChart.destroy();
                const ctx = document.getElementById('adminAttendanceChart').getContext('2d');
                adminChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: activities.map(a => a.name),
                        datasets: [{ label: 'متوسط الحضور', data: avgAttendance, backgroundColor: activities.map(a => a.color), borderColor: activities.map(a => a.borderColor), borderWidth: 1, borderRadius: 5 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }, plugins: { legend: { display: false } } }
                });

            } else {
                DOMElements.totalServantsStat.textContent = servantsCache.length;
                const birthdayContainer = DOMElements.upcomingBirthdayStat;
                const upcomingBirthdays = getUpcomingBirthdays(servantsCache, 100);

                if (upcomingBirthdays.length > 0) {
                    birthdayContainer.innerHTML = '<ul class="space-y-1"></ul>';
                    const ul = birthdayContainer.querySelector('ul');
                    upcomingBirthdays.forEach(person => {
                        const dayText = person.daysUntil === 0 ? 'اليوم!' : `بعد ${person.daysUntil} يوم`;
                        ul.innerHTML += `
                            <li class="flex justify-between items-center p-2 rounded-lg hover:bg-pink-50 dark:hover:bg-pink-900/20">
                                <div>
                                    <p class="font-semibold text-gray-800 dark:text-gray-200 text-sm">${person.name}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${person.date}</p>
                                </div>
                                <span class="text-sm font-bold text-pink-500">${dayText}</span>
                            </li>
                        `;
                    });
                } else {
                    birthdayContainer.innerHTML = '<p class="text-gray-500 text-center pt-4">لا توجد أعياد ميلاد قادمة.</p>';
                }

                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const startDate = thirtyDaysAgo.toISOString().split('T')[0];
                const endDate = new Date().toISOString().split('T')[0];
                
                const attendanceObject = await fetchData('attendance', currentServiceName);
                const attendanceData = Object.entries(attendanceObject).map(([date, data]) => ({ date, ...data }));
                const filteredAttendance = attendanceData.filter(item => item.date >= startDate && item.date <= endDate);
                
                const activityTotals = {}, activityCounts = {};
                activities.forEach(act => { activityTotals[act.key] = 0; activityCounts[act.key] = 0; });

                filteredAttendance.forEach(day => {
                    activities.forEach(activity => {
                        const activityData = day[activity.key];
                        if (activityData && (activityData.note === null || activityData.note === undefined)) {
                            activityTotals[activity.key] += activityData.attendees.length;
                            activityCounts[activity.key]++;
                        }
                    });
                });

                const avgAttendance = activities.map(activity => {
                    const totalAttendees = activityTotals[activity.key];
                    const totalMeetings = activityCounts[activity.key];
                    if (totalMeetings === 0 || servantsCache.length === 0) return 0;
                    return Math.round(((totalAttendees / totalMeetings) / servantsCache.length) * 100);
                });

                if (homeChart) homeChart.destroy();
                const ctx = document.getElementById('homeAttendanceChart').getContext('2d');
                homeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: activities.map(a => a.name),
                        datasets: [{ label: 'متوسط الحضور', data: avgAttendance, backgroundColor: activities.map(a => a.color), borderColor: activities.map(a => a.borderColor), borderWidth: 1, borderRadius: 5 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }, plugins: { legend: { display: false } } }
                });

                const currentYear = new Date().getFullYear();
                const isCacheValid = attendanceYearCache && Object.keys(attendanceYearCache).length > 0 && Object.values(attendanceYearCache)[0].year === currentYear;
                if (!isCacheValid) {
                    await loadAttendanceForYear(currentYear);
                }

                const lastFridayAbsenceContainer = DOMElements.lastFridayAbsenceStat;
                const { dateString: lastFridayDateString } = getLastFriday();
                const lastFridayData = attendanceYearCache[lastFridayDateString];

                if (lastFridayData && lastFridayData.service) {
                    const serviceActivity = lastFridayData.service;
                    if (serviceActivity.note) {
                        lastFridayAbsenceContainer.innerHTML = `<p class="text-yellow-600 dark:text-yellow-400 font-semibold">تم إلغاء الخدمة يوم الجمعة الماضية.</p>`;
                    } else {
                        const attendees = new Set(serviceActivity.attendees || []);
                        const absentees = servantsCache.filter(servant => !attendees.has(servant.id));

                        if (absentees.length > 0) {
                            let listHTML = '<ul class="space-y-2 max-h-[70px] overflow-y-auto">';
                            absentees.forEach(servant => {
                                listHTML += `<li class="p-1.5 bg-red-50 dark:bg-red-900/20 rounded-md font-semibold text-red-700 dark:text-red-400 flex items-center"><i class="fas fa-times-circle text-red-400 mr-2"></i>${servant.name}</li>`;
                            });
                            listHTML += '</ul>';
                            lastFridayAbsenceContainer.innerHTML = listHTML;
                        } else {
                            lastFridayAbsenceContainer.innerHTML = `<p class="text-green-600 dark:text-green-400 font-semibold flex items-center"><i class="fas fa-check-circle mr-2"></i>لا يوجد غياب! كل الخدام حضروا الخدمة.</p>`;
                        }
                    }
                } else {
                    lastFridayAbsenceContainer.innerHTML = '<p class="text-gray-400">لم يتم تسجيل حضور الخدمة للجمعة الماضية بعد.</p>';
                }

                const lastFridayStatusContainer = DOMElements.lastFridayStatusContainer;
                lastFridayStatusContainer.innerHTML = '';
                activities.forEach(act => {
                    const activityData = lastFridayData ? lastFridayData[act.key] : undefined;
                    let statusClass = 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300';
                    let statusIcon = 'fa-times-circle';
                    let statusText = 'لم يسجل';
                    let isClickable = false;

                    if (activityData) {
                        if (activityData.note !== null && activityData.note !== undefined) {
                            statusClass = 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300';
                            statusIcon = 'fa-exclamation-circle';
                            statusText = 'ملغى';
                        } else {
                            statusClass = 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300';
                            statusIcon = 'fa-check-circle';
                            statusText = 'مسجل';
                            isClickable = true;
                        }
                    }

                    lastFridayStatusContainer.innerHTML += `
                        <div data-activity-key="${act.key}" class="activity-status-card p-3 rounded-lg flex flex-col items-center justify-center text-center ${statusClass} ${isClickable ? 'cursor-pointer hover:ring-2 hover:ring-cyan-400 transition-all' : ''}">
                            <i class="fas ${act.icon} text-2xl mb-2"></i>
                            <p class="font-bold text-sm">${act.name}</p>
                            <p class="text-xs font-semibold flex items-center gap-1 mt-1"><i class="fas ${statusIcon}"></i> ${statusText}</p>
                        </div>
                    `;
                });
            }
        }

        function renderAdminServantsTable(servantsToRender) {
            DOMElements.adminServantsTableBody.innerHTML = '';
            if (!servantsToRender || servantsToRender.length === 0) {
                 DOMElements.adminServantsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-500">لا يوجد خدام لعرضهم.</td></tr>`;
                 return;
            }
            servantsToRender.forEach(servant => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700/50 transition-colors';
                const val = (data) => data || 'غير متوفر';
                row.innerHTML = `
                    <td class="p-3 font-semibold"><a href="#" class="text-cyan-600 hover:underline" data-servant-id="${servant.id}">${val(servant.name)}</a></td>
                    <td class="p-3">${val(servant.serviceName)}</td>
                    <td class="p-3">${val(servant.mobile)}</td>`;
                DOMElements.adminServantsTableBody.appendChild(row);
            });
        }


        // --- EVENT LISTENERS INITIALIZATION ---
        function initializeEventListeners() {
            // Main navigation
            DOMElements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOMElements.errorMessage.textContent = '';
                const isAdminLogin = currentServiceName === 'الامين العام';
                isGeneralSecretaryMode = false;
                if (isAdminLogin && DOMElements.codeInput.value === ADMIN_CODE) {
                    isGeneralSecretaryMode = true;
                    closeModal(DOMElements.loginModal);
                    DOMElements.codeInput.value = '';
                    await showDashboard();
                } else if (!isAdminLogin && DOMElements.codeInput.value === CORRECT_CODE) {
                    closeModal(DOMElements.loginModal);
                    DOMElements.codeInput.value = '';
                    await showDashboard();
                } else {
                    DOMElements.errorMessage.textContent = 'الكود غير صحيح. حاول مرة أخرى.';
                }
            });

            DOMElements.sidebar.addEventListener('click', (e) => {
                const link = e.target.closest('.sidebar-link');
                if (link) { e.preventDefault(); switchPage(link.dataset.page); }
            });
            
            DOMElements.logoutBtn.addEventListener('click', returnToMainMenu);
            DOMElements.backToServicesBtn.addEventListener('click', returnToMainMenu);
            
            DOMElements.servicesGrid.addEventListener('click', (e) => {
                const card = e.target.closest('.service-card');
                if (card) {
                    currentServiceName = card.dataset.serviceName;
                    document.getElementById('modalTitle').textContent = `الدخول إلى ${currentServiceName}`;
                    openModal(DOMElements.loginModal);
                    setTimeout(() => DOMElements.codeInput.focus(), 100);
                }
            });
            
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal-backdrop')));
            });

            // Home Page Listeners
            DOMElements.backupBtn.addEventListener('click', backupData);
            DOMElements.restoreBtn.addEventListener('click', restoreData);
            DOMElements.quickAddServant.addEventListener('click', () => {
                 DOMElements.manualEntryForm.reset();
                DOMElements.manualEntryForm.querySelector('#servantId').value = '';
                DOMElements.manualEntryModalTitle.textContent = 'إضافة خادم جديد';
                DOMElements.imagePreview.classList.add('hidden');
                DOMElements.imagePreview.src = '';
                openModal(DOMElements.manualEntryModal);
            });
            DOMElements.quickGoToAttendance.addEventListener('click', () => switchPage('attendancePage'));
            DOMElements.adminSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const filteredServants = allServantsCache.filter(servant => 
                    (servant.name && servant.name.toLowerCase().includes(searchTerm)) ||
                    (servant.mobile && String(servant.mobile).includes(searchTerm))
                );
                renderAdminServantsTable(filteredServants);
            });
            DOMElements.addAnnouncementBtn.addEventListener('click', addAnnouncement);
            DOMElements.adminServantsTableBody.addEventListener('click', (e) => {
                if(e.target.tagName === 'A' && e.target.dataset.servantId) {
                    e.preventDefault();
                    showUnifiedProfile(e.target.dataset.servantId);
                }
            });
            DOMElements.totalServantsCard.addEventListener('click', () => switchPage('servantsPage'));
            DOMElements.lastFridayStatusContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.activity-status-card');
                if (card && card.classList.contains('cursor-pointer')) {
                    showActivityAttendees(card.dataset.activityKey);
                }
            });


            // Servants Page Listeners
            DOMElements.searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const filteredServants = servantsCache.filter(servant => 
                    (servant.name && servant.name.toLowerCase().includes(searchTerm)) ||
                    (servant.mobile && String(servant.mobile).includes(searchTerm))
                );
                renderServantsTable(filteredServants);
            });
            DOMElements.servantsActions.querySelector('#addManualBtn').addEventListener('click', () => {
                DOMElements.manualEntryForm.reset();
                DOMElements.manualEntryForm.querySelector('#servantId').value = '';
                DOMElements.manualEntryModalTitle.textContent = 'إضافة خادم جديد';
                DOMElements.imagePreview.classList.add('hidden');
                DOMElements.imagePreview.src = '';
                openModal(DOMElements.manualEntryModal);
            });
            DOMElements.servantsActions.querySelector('#importExcelBtn').addEventListener('click', () => openModal(DOMElements.importModal));
            DOMElements.manualEntryForm.addEventListener('submit', handleServantFormSubmit);
            DOMElements.importForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const file = DOMElements.importForm.querySelector('#excelFile').files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        showLoading(true);
                        const data = new Uint8Array(event.target.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = window.XLSX.utils.sheet_to_json(worksheet, { 
                            header: ['id', 'image', 'name', 'nationalId', 'mobile', 'currentService', 'address', 'dob', 'qualification', 'job', 'confessionFather'],
                            range: 4 
                        });
                        
                        let importedCount = 0;
                        for (const servant of json) {
                            if (!servant.name) continue;
                            if (servant.dob && !isNaN(servant.dob)) {
                                const dobNumber = Number(servant.dob);
                                if (dobNumber > 1) {
                                    const excelDate = new Date((dobNumber - 25569) * 86400 * 1000);
                                    if (!isNaN(excelDate.getTime())) {
                                        servant.dob = excelDate.toISOString().split('T')[0];
                                    } else {
                                        servant.dob = null;
                                    }
                                }
                            }
                            await addServant(servant);
                            importedCount++;
                        }
                        closeModal(DOMElements.importModal);
                        DOMElements.importForm.reset();
                        showMessage(`تم استيراد ${importedCount} خادم بنجاح.`);
                    } catch (err) {
                        showMessage('حدث خطأ أثناء قراءة الملف.', true);
                        console.error(err);
                    } finally {
                        showLoading(false);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
            DOMElements.servantsTableBody.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) handleEditClick(editBtn.dataset.id);
                if (deleteBtn) deleteServant(deleteBtn.dataset.id);
            });

            DOMElements.servantImageFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 300;
                            const MAX_HEIGHT = 300;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            
                            DOMElements.imagePreview.src = dataUrl;
                            DOMElements.imagePreview.classList.remove('hidden');
                        }
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });


            // Attendance Page Listeners
            DOMElements.yearSelector.addEventListener('change', async () => {
                const year = DOMElements.yearSelector.value;
                DOMElements.monthSelector.disabled = true;
                DOMElements.fridaysGrid.innerHTML = '';
                DOMElements.activityButtons.classList.add('hidden-view');
                DOMElements.attendanceListContainer.classList.add('hidden-view');
                if (year) {
                    showLoading(true);
                    await loadAttendanceForYear(year);
                    showLoading(false);
                    populateMonths(year);
                } else {
                    DOMElements.monthSelector.innerHTML = '<option value="">اختر شهر</option>';
                }
            });

            DOMElements.monthSelector.addEventListener('change', async () => {
                const year = parseInt(DOMElements.yearSelector.value);
                const month = parseInt(DOMElements.monthSelector.value);
                if (!isNaN(year) && !isNaN(month) && month >= 0) {
                    populateFridaysGrid(year, month);
                } else {
                    DOMElements.fridaysGrid.innerHTML = '';
                }
                DOMElements.activityButtons.classList.add('hidden-view');
                DOMElements.attendanceListContainer.classList.add('hidden-view');
            });

            DOMElements.fridaysGrid.addEventListener('click', (e) => {
                const button = e.target.closest('.friday-btn');
                if (button) {
                    document.querySelectorAll('.friday-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    selectedFriday = button.dataset.date;
                    updateActivityButtonsStatus(selectedFriday);
                    DOMElements.attendanceListContainer.classList.add('hidden-view');
                }
            });

            DOMElements.activityButtons.addEventListener('click', (e) => {
                const button = e.target.closest('.activity-btn');
                if (button) {
                    const activity = button.dataset.activity;
                    if (selectedFriday) {
                        showActivityChecklist(activity, selectedFriday);
                    } else {
                        showMessage("الرجاء اختيار يوم الجمعة أولاً.", true);
                    }
                }
            });
            
            DOMElements.saveActivityAttendanceBtn.addEventListener('click', saveActivityAttendance);


            // Reports Page Listeners
            document.getElementById('reportTabs').addEventListener('click', (e) => {
                const tab = e.target.closest('.report-tab');
                if (tab) {
                    document.querySelectorAll('.report-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentReportType = tab.dataset.reportType;

                    const isComparison = currentReportType === 'comparison';
                    DOMElements.standardReportsContainer.classList.toggle('hidden-view', isComparison);
                    DOMElements.comparisonReportContainer.classList.toggle('hidden-view', !isComparison);
                    
                    if (!isComparison) {
                        DOMElements.reportOutput.classList.add('hidden-view');
                        DOMElements.servantSelectorContainer.classList.toggle('hidden-view', currentReportType !== 'individual');
                    }
                }
            });
            DOMElements.reportServiceSelector.addEventListener('change', () => {
                const selectedService = DOMElements.reportServiceSelector.value;
                const filteredServants = selectedService === 'all'
                    ? allServantsCache 
                    : allServantsCache.filter(s => s.serviceName === selectedService);
                populateReportServantSelector(filteredServants);
            });
            DOMElements.generateReportBtn.addEventListener('click', triggerReportGeneration);
            DOMElements.generateComparisonBtn.addEventListener('click', generateComparisonReport);
            DOMElements.exportPngBtn.addEventListener('click', exportAsImage);
            DOMElements.exportPdfBtn.addEventListener('click', exportAsPdf);
            
            // Activity Analysis Page Listeners
            DOMElements.generateAnalysisBtn.addEventListener('click', generateAbsenceAnalysis);
            DOMElements.exportAnalysisBtn.addEventListener('click', exportAnalysisAsImage);

            // Theme Toggle Listener
            DOMElements.themeCheckbox.addEventListener('change', toggleTheme);

            // Mobile Sidebar Listeners
            DOMElements.hamburgerBtn.addEventListener('click', () => {
                DOMElements.sidebar.classList.remove('translate-x-full');
                DOMElements.sidebarOverlay.classList.remove('hidden');
            });
            DOMElements.sidebarOverlay.addEventListener('click', () => {
                DOMElements.sidebar.classList.add('translate-x-full');
                DOMElements.sidebarOverlay.classList.add('hidden');
            });
        }

        // ==================================================================
        // --- NEW/MODIFIED FUNCTIONS FOR SECRETARY GENERAL ---
        // ==================================================================

        function getLastFriday() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // Sunday = 0, Friday = 5
            const daysToSubtract = (dayOfWeek + 2) % 7; 
            const lastFriday = new Date(today);
            lastFriday.setDate(today.getDate() - daysToSubtract);
            lastFriday.setHours(0, 0, 0, 0);
            
            const y = lastFriday.getFullYear();
            const m = String(lastFriday.getMonth() + 1).padStart(2, '0');
            const d = String(lastFriday.getDate()).padStart(2, '0');
            
            return {
                date: lastFriday,
                dateString: `${y}-${m}-${d}`
            };
        }

        function populateAnnouncementTargetSelector() {
            const container = document.getElementById('announcementTarget');
            if (!container) return;
            container.innerHTML = ''; // Clear previous content

            container.innerHTML += `
                <div class="flex items-center p-1">
                    <input id="announcement-target-all" type="checkbox" value="all" class="w-4 h-4 text-cyan-600 bg-gray-100 border-gray-300 rounded focus:ring-cyan-500 ml-2 cursor-pointer">
                    <label for="announcement-target-all" class="font-bold cursor-pointer">الكل</label>
                </div>
            `;

            const serviceNames = services
                .filter(s => s.name !== 'الامين العام')
                .map(s => s.name);
            serviceNames.sort((a,b) => a.localeCompare(b,'ar')).forEach(name => {
                const checkboxId = `ann-target-${name.replace(/\s+/g, '-')}`;
                container.innerHTML += `
                    <div class="flex items-center p-1">
                        <input id="${checkboxId}" type="checkbox" value="${name}" class="w-4 h-4 text-cyan-600 bg-gray-100 border-gray-300 rounded focus:ring-cyan-500 ml-2 cursor-pointer service-target-checkbox">
                        <label for="${checkboxId}" class="cursor-pointer">${name}</label>
                    </div>
                `;
            });

            const allCheckbox = container.querySelector('#announcement-target-all');
            const serviceCheckboxes = container.querySelectorAll('.service-target-checkbox');
            allCheckbox.addEventListener('change', (e) => {
                serviceCheckboxes.forEach(cb => {
                    cb.checked = e.target.checked;
                });
            });

            serviceCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!cb.checked) {
                        allCheckbox.checked = false;
                    } else {
                        const allChecked = Array.from(serviceCheckboxes).every(c => c.checked);
                        allCheckbox.checked = allChecked;
                    }
                });
            });
        }

        function listenForAnnouncements() {
            if (announcementsUnsubscribe) announcementsUnsubscribe();
            const announcementsCol = collection(db, 'announcements');
            const q = query(announcementsCol, orderBy('timestamp', 'desc'));
            announcementsUnsubscribe = onSnapshot(q, (snapshot) => {
                const announcements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayAnnouncements(announcements);
            });
        }

        function displayAnnouncements(announcements) {
            const adminList = DOMElements.adminAnnouncementsList;
            const userDisplay = DOMElements.announcementsDisplay;
            
            if (adminList && isGeneralSecretaryMode) {
                adminList.innerHTML = '';
                if (announcements.length === 0) {
                    adminList.innerHTML = '<p class="text-gray-500">لا توجد إعلانات حالياً.</p>';
                } else {
                    announcements.forEach(ann => {
                        const date = ann.timestamp?.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'short' }) || 'غير محدد';
                        const targets = ann.targetServices || ['غير محدد'];
                        const targetText = targets.includes('all') ? 'الكل' : targets.join(', ');

                        adminList.innerHTML += `
                            <div class="bg-gray-100 dark:bg-gray-700/50 p-3 rounded-lg flex justify-between items-start gap-4">
                                <div>
                                    <p class="text-gray-800 dark:text-gray-200">${ann.text}</p>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center gap-4">
                                        <span><i class="fas fa-calendar-alt mr-1"></i> ${date}</span>
                                        <span><i class="fas fa-bullseye mr-1"></i> <strong>موجه إلى:</strong> ${targetText}</span>
                                    </div>
                                </div>
                                <button data-id="${ann.id}" class="delete-announcement-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>`;
                    });
                    adminList.querySelectorAll('.delete-announcement-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            showConfirm('تأكيد الحذف', 'هل أنت متأكد من حذف هذا الإعلان؟', async () => {
                                 await deleteDoc(doc(db, 'announcements', id));
                                 showMessage('تم حذف الإعلان.');
                            });
                        });
                    });
                }
            }

            if (userDisplay && !isGeneralSecretaryMode) {
                userDisplay.innerHTML = '';
                const relevantAnnouncements = announcements.filter(ann => 
                    ann.targetServices && (ann.targetServices.includes('all') || ann.targetServices.includes(currentServiceName))
                );

                if (relevantAnnouncements.length > 0) {
                    const latestAnn = relevantAnnouncements[0];
                    userDisplay.innerHTML = `
                        <div class="bg-cyan-100 dark:bg-cyan-900 border-r-4 border-cyan-500 text-cyan-800 dark:text-cyan-200 p-4 rounded-lg shadow">
                            <div class="flex items-center">
                                <i class="fas fa-bullhorn text-2xl ml-4"></i>
                                <div>
                                    <h4 class="font-bold">إعلان هام من الأمين العام</h4>
                                    <p>${latestAnn.text}</p>
                                </div>
                            </div>
                        </div>`;
                }
            }
        }

        async function addAnnouncement() {
            const input = DOMElements.newAnnouncementInput;
            const text = input.value.trim();
            const targetContainer = document.getElementById('announcementTarget');
            const allCheckbox = targetContainer.querySelector('#announcement-target-all');
            const selectedCheckboxes = Array.from(targetContainer.querySelectorAll('.service-target-checkbox:checked'));
            const selectedOptions = selectedCheckboxes.map(cb => cb.value);

            if (text && (allCheckbox.checked || selectedOptions.length > 0)) {
                const targetServices = allCheckbox.checked ? ['all'] : selectedOptions;
                
                try {
                    await addDoc(collection(db, 'announcements'), {
                        text: text,
                        targetServices: targetServices,
                        timestamp: serverTimestamp()
                    });
                    input.value = '';
                    targetContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    showMessage('تم إضافة الإعلان بنجاح.');
                } catch (error) {
                    console.error("Error adding announcement: ", error);
                    showMessage('فشل إضافة الإعلان.', true);
                }
            } else {
                showMessage('الرجاء كتابة نص الإعلان واختيار خدمة واحدة على الأقل.', true);
            }
        }

        function renderAdminKPIs() {
            const kpiContainer = DOMElements.kpiContainer;
            kpiContainer.innerHTML = '';
            kpiContainer.className = 'grid grid-cols-1 sm:grid-cols-2 gap-6';

            kpiContainer.innerHTML += createKpiCard('users', 'إجمالي الخدام', allServantsCache.length, 'خادم في جميع الخدمات', 'bg-blue-100 dark:bg-blue-800', 'text-blue-600');

            const serviceAttendance = {};
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            allAttendanceCache.forEach(item => {
                const itemDate = new Date(item.date);
                if (itemDate.getMonth() === currentMonth && itemDate.getFullYear() === currentYear) {
                    if (!serviceAttendance[item.serviceName]) {
                        serviceAttendance[item.serviceName] = { totalAttendees: 0, totalPossible: 0 };
                    }
                    const serviceServantsCount = allServantsCache.filter(s => s.serviceName === item.serviceName).length;
                    if (serviceServantsCount > 0) {
                        Object.keys(item).forEach(key => {
                            if (activityMap.has(key) && item[key].attendees) {
                                serviceAttendance[item.serviceName].totalAttendees += item[key].attendees.length;
                                serviceAttendance[item.serviceName].totalPossible += serviceServantsCount;
                            }
                        });
                    }
                }
            });
            let topService = { name: 'لا يوجد', avg: 0 };
            for (const serviceName in serviceAttendance) {
                const data = serviceAttendance[serviceName];
                const avg = data.totalPossible > 0 ? (data.totalAttendees / data.totalPossible) * 100 : 0;
                if (avg > topService.avg) {
                    topService = { name: serviceName, avg: avg };
                }
            }
            kpiContainer.innerHTML += createKpiCard('star', 'الخدمة الأعلى حضوراً', topService.name, `${topService.avg.toFixed(1)}% هذا الشهر`, 'bg-green-100 dark:bg-green-800', 'text-green-600');
        }

        function renderFollowUpPanel(servantAttendanceSummary) {
            const container = DOMElements.followUpPanel;
            if (!container) return;

            const needsFollowUp = Object.values(servantAttendanceSummary)
                .map(s => ({ ...s, percentage: s.possible > 0 ? (s.attended / s.possible) * 100 : 0 }))
                .filter(s => s.possible > 4 && s.percentage < 50)
                .sort((a, b) => a.percentage - b.percentage);

            if (needsFollowUp.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">لا يوجد خدام حالياً بحاجة للمتابعة.</p>';
                return;
            }

            container.innerHTML = needsFollowUp.map(s => `
                <div class="p-2.5 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/50 flex justify-between items-center transition-colors">
                    <div>
                        <p class="font-semibold text-sm">${s.name}</p>
                        <p class="text-xs text-gray-500">${s.service}</p>
                    </div>
                    <div class="text-red-500 font-bold text-sm">${s.percentage.toFixed(0)}%</div>
                </div>
            `).join('');
        }

        function renderBirthdaysPanel() {
            const container = DOMElements.birthdaysPanel;
            if (!container) return;

            const upcomingBdays = getUpcomingBirthdays(allServantsCache, 100); // Get all in next 30 days

            if (upcomingBdays.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center p-4">لا توجد أعياد ميلاد خلال الـ 30 يوم القادمة.</p>';
                return;
            }

            container.innerHTML = upcomingBdays.map(bday => `
                 <div class="p-2.5 rounded-lg hover:bg-pink-100 dark:hover:bg-pink-900/50 flex justify-between items-center transition-colors">
                    <div>
                        <p class="font-semibold text-sm">${bday.name}</p>
                        <p class="text-xs text-gray-500">${bday.serviceName}</p>
                    </div>
                    <div class="text-pink-500 font-bold text-sm whitespace-nowrap">${bday.date}</div>
                </div>
            `).join('');
        }

        function renderAttendanceFollowUpPanel() {
            const container = DOMElements.attendanceFollowUpPanel;
            if (!container) return;

            const { date, dateString } = getLastFriday();
            const formattedDate = date.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long' });
            
            const legendHTML = `
                <div class="flex-shrink-0">
                    <p class="text-sm text-gray-500 mb-2">آخر جمعة: ${formattedDate}</p>
                    <div class="mb-3 pb-3 border-b border-gray-200 dark:border-gray-700">
                        <p class="text-xs font-bold mb-1 text-center">ترتيب الأنشطة (من اليمين لليسار):</p>
                        <div class="text-xs text-gray-600 dark:text-gray-400 text-center leading-tight">
                            ${activities.map(act => act.name).join(' - ')}
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs text-center mt-2">
                            <div><span class="w-3 h-3 bg-green-500 rounded-full inline-block mr-1"></span> مسجل</div>
                            <div><span class="w-3 h-3 bg-yellow-400 rounded-full inline-block mr-1"></span> ملغى</div>
                            <div><span class="w-3 h-3 bg-red-500 rounded-full inline-block mr-1"></span> لم يسجل</div>
                        </div>
                    </div>
                </div>
            `;

            const servicesToCheck = services.filter(s => s.name !== 'الامين العام');
            let allActivitiesComplete = true;

            const serviceListHTML = servicesToCheck.map(service => {
                const serviceName = service.name;
                const attendanceRecord = allAttendanceCache.find(rec => rec.date === dateString && rec.serviceName === serviceName);
                
                let hasMissingActivities = false;
                const dotsHTML = activities.map(act => {
                    const activityData = attendanceRecord ? attendanceRecord[act.key] : undefined;
                    if (activityData) {
                        if (activityData.note !== null && activityData.note !== undefined) {
                            return '<span class="w-3 h-3 bg-yellow-400 rounded-full" title="ملغى"></span>';
                        }
                        return '<span class="w-3 h-3 bg-green-500 rounded-full" title="مسجل"></span>';
                    } else {
                        hasMissingActivities = true;
                        allActivitiesComplete = false;
                        return '<span class="w-3 h-3 bg-red-500 rounded-full" title="لم يسجل"></span>';
                    }
                }).join('');

                return `
                    <div class="p-2.5 rounded-lg flex justify-between items-center ${hasMissingActivities ? 'bg-red-100 dark:bg-red-900/50' : 'bg-gray-100 dark:bg-gray-700/50'}">
                        <p class="font-semibold text-sm">${serviceName}</p>
                        <div class="flex items-center gap-1.5">${dotsHTML}</div>
                    </div>
                `;
            }).join('');
            
            let contentHTML = '';
            if (allActivitiesComplete) {
                 contentHTML = `
                    <div class="p-3 rounded-lg bg-green-100 dark:bg-green-900/50 text-center flex-grow flex items-center justify-center">
                        <div>
                           <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                           <p class="font-semibold text-sm text-green-700 dark:text-green-300">ممتاز! جميع الأنشطة مسجلة لآخر جمعة.</p>
                        </div>
                    </div>`;
            } else {
                 contentHTML = `<div class="overflow-y-auto flex-grow space-y-2">${serviceListHTML}</div>`;
            }

            container.innerHTML = legendHTML + contentHTML;
        }

        function updateAdminDashboard() {
            renderAdminKPIs();
        }

        function updateFollowUpPage() {
            const servantAttendanceSummary = {};
            allServantsCache.forEach(s => servantAttendanceSummary[s.id] = { attended: 0, possible: 0, name: s.name, service: s.serviceName });
            
            const lastThreeMonths = new Date();
            lastThreeMonths.setMonth(lastThreeMonths.getMonth() - 3);
            
            allAttendanceCache.filter(rec => new Date(rec.date) >= lastThreeMonths).forEach(item => {
                activities.forEach(act => {
                    if(item[act.key] && Array.isArray(item[act.key].attendees)) {
                        const presentIds = new Set(item[act.key].attendees);
                        const serviceServants = allServantsCache.filter(s => s.serviceName === item.serviceName);
                        serviceServants.forEach(servant => {
                            if (servantAttendanceSummary[servant.id]) {
                                servantAttendanceSummary[servant.id].possible++;
                                if(presentIds.has(servant.id)) servantAttendanceSummary[servant.id].attended++;
                            }
                        });
                    }
                });
            });

            renderAttendanceFollowUpPanel();
            renderFollowUpPanel(servantAttendanceSummary);
            renderBirthdaysPanel();
        }
        
        function createKpiCard(icon, title, value, subtext, bgColor, textColor) {
            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg flex items-center gap-4">
                    <div class="${bgColor} p-4 rounded-full flex-shrink-0">
                        <i class="fas fa-${icon} ${textColor} text-2xl w-8 h-8 text-center leading-8"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 dark:text-gray-400 font-bold">${title}</p>
                        <p class="text-2xl font-bold truncate" title="${value}">${value}</p>
                        <div class="text-gray-500 dark:text-gray-400 text-sm">${subtext}</div>
                    </div>
                </div>`;
        }
        
        function showUnifiedProfile(servantId) {
            const servant = allServantsCache.find(s => s.id === servantId);
            if (!servant) return;

            const activityBreakdown = {};
            activities.forEach(act => activityBreakdown[act.key] = { attended: 0, possible: 0 });

            const servantRecords = allAttendanceCache.filter(rec => rec.serviceName === servant.serviceName);
            
            servantRecords.forEach(item => {
                 activities.forEach(act => {
                    if(item[act.key] && Array.isArray(item[act.key].attendees)) {
                        activityBreakdown[act.key].possible++;
                        if(item[act.key].attendees.includes(servantId)) {
                            activityBreakdown[act.key].attended++;
                        }
                    }
                 });
            });

            let breakdownHTML = '';
            for(const key in activityBreakdown) {
                const data = activityBreakdown[key];
                const percentage = data.possible > 0 ? Math.round((data.attended / data.possible) * 100) : 0;
                breakdownHTML += `
                    <div>
                        <p class="text-sm font-semibold">${activityMap.get(key).name}</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5">
                            <div class="${getPercentageColor(percentage)} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-xs text-right">${data.attended}/${data.possible} (${percentage}%)</p>
                    </div>
                `;
            }

            const val = (data) => data || 'غير متوفر';
            const body = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 text-center">
                        <img src="${servant.imageUrl || 'https://placehold.co/120x120/E2E8F0/4A5568?text=?'}" class="w-32 h-32 rounded-full mx-auto object-cover border-4 border-cyan-500 shadow-lg">
                        <h4 class="h3 mt-3">${val(servant.name)}</h4>
                        <p class="text-gray-500">${val(servant.serviceName)}</p>
                    </div>
                    <div class="md:col-span-2 space-y-4">
                        <div>
                            <h3 class="h3 border-b pb-2 mb-3">المعلومات الشخصية</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                                <p class="flex items-center"><i class="fas fa-mobile-alt w-5 ml-2 text-cyan-600"></i><strong>الموبايل:</strong><span class="mr-2">${val(servant.mobile)}</span></p>
                                <p class="flex items-center"><i class="fas fa-birthday-cake w-5 ml-2 text-cyan-600"></i><strong>ت. الميلاد:</strong><span class="mr-2">${val(servant.dob)}</span></p>
                                <p class="flex items-center col-span-2"><i class="fas fa-id-card w-5 ml-2 text-cyan-600"></i><strong>الرقم القومي:</strong><span class="mr-2">${val(servant.nationalId)}</span></p>
                                <p class="flex items-center col-span-2"><i class="fas fa-map-marker-alt w-5 ml-2 text-cyan-600"></i><strong>العنوان:</strong><span class="mr-2">${val(servant.address)}</span></p>
                            </div>
                        </div>
                        <div>
                            <h3 class="h3 border-b pb-2 mb-3">بيانات الخدمة</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                                <p class="flex items-center"><i class="fas fa-briefcase w-5 ml-2 text-cyan-600"></i><strong>الوظيفة:</strong><span class="mr-2">${val(servant.job)}</span></p>
                                <p class="flex items-center"><i class="fas fa-graduation-cap w-5 ml-2 text-cyan-600"></i><strong>المؤهل:</strong><span class="mr-2">${val(servant.qualification)}</span></p>
                                <p class="flex items-center col-span-2"><i class="fas fa-cross w-5 ml-2 text-cyan-600"></i><strong>أب الاعتراف:</strong><span class="mr-2">${val(servant.confessionFather)}</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 border-t dark:border-gray-700 pt-4">
                    <h3 class="h3 mb-3">ملخص الحضور العام</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        ${breakdownHTML}
                    </div>
                </div>
                 <div class="mt-6 border-t dark:border-gray-700 pt-4">
                    <h3 class="h3 mb-2">معدل الحضور الشهري (آخر 3 أشهر)</h3>
                    <div class="relative h-48"><canvas id="profileAttendanceChart"></canvas></div>
                </div>
            `;
            DOMElements.unifiedProfileModalBody.innerHTML = body;
            openModal(DOMElements.unifiedProfileModal);
            
            generateProfileAttendanceChart(servantId, servant.serviceName);
        }
        
        function generateProfileAttendanceChart(servantId, serviceName) {
            const monthlyData = {};
            const monthLabels = [];
            
            for (let i = 2; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthLabels.push(d.toLocaleDateString('ar-EG', { month: 'short', year: 'numeric' }));
                monthlyData[monthKey] = { attended: 0, possible: 0 };
            }

            const servantRecords = allAttendanceCache.filter(rec => rec.serviceName === serviceName);
            servantRecords.forEach(item => {
                const itemMonthKey = item.date.substring(0, 7);
                if (monthlyData[itemMonthKey]) {
                    activities.forEach(act => {
                        if (item[act.key] && Array.isArray(item[act.key].attendees)) {
                            monthlyData[itemMonthKey].possible++;
                            if (item[act.key].attendees.includes(servantId)) {
                                monthlyData[itemMonthKey].attended++;
                            }
                        }
                    });
                }
            });

            const percentages = Object.values(monthlyData).map(data => 
                data.possible > 0 ? Math.round((data.attended / data.possible) * 100) : 0
            );

            if (profileChart) profileChart.destroy();
            const ctx = document.getElementById('profileAttendanceChart').getContext('2d');
            profileChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'نسبة الحضور',
                        data: percentages,
                        borderColor: 'rgb(14, 116, 144)', // cyan-700
                        backgroundColor: 'rgba(14, 116, 144, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function populateComparisonSelectors() {
            const selectors = [DOMElements.comparisonServiceSelector1, DOMElements.comparisonServiceSelector2];
            const serviceNames = services.filter(s => s.name !== 'الامين العام').map(s => s.name);
            selectors.forEach(selector => {
                selector.innerHTML = '<option value="">اختر خدمة</option>';
                serviceNames.forEach(name => {
                    selector.innerHTML += `<option value="${name}">${name}</option>`;
                });
            });
        }

        function generateComparisonReport() {
            const service1 = DOMElements.comparisonServiceSelector1.value;
            const service2 = DOMElements.comparisonServiceSelector2.value;

            if (!service1 || !service2) {
                return showMessage('الرجاء اختيار خدمتين للمقارنة.', true);
            }
            if (service1 === service2) {
                return showMessage('الرجاء اختيار خدمتين مختلفتين.', true);
            }

            const calculateAverages = (serviceName) => {
                const serviceServantsCount = allServantsCache.filter(s => s.serviceName === serviceName).length;
                if (serviceServantsCount === 0) return activities.map(() => 0);
                
                const activityTotals = {};
                activities.forEach(act => activityTotals[act.key] = { attended: 0, possible: 0 });

                allAttendanceCache.filter(rec => rec.serviceName === serviceName).forEach(item => {
                    activities.forEach(act => {
                        if (item[act.key] && item[act.key].attendees) {
                            activityTotals[act.key].attended += item[act.key].attendees.length;
                            activityTotals[act.key].possible += serviceServantsCount;
                        }
                    });
                });
                
                return activities.map(act => {
                    const data = activityTotals[act.key];
                    return data.possible > 0 ? Math.round((data.attended / data.possible) * 100) : 0;
                });
            };

            const data1 = calculateAverages(service1);
            const data2 = calculateAverages(service2);

            if (comparisonChart) comparisonChart.destroy();
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: activities.map(a => a.name),
                    datasets: [
                        { label: service1, data: data1, backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 },
                        { label: service2, data: data2, backgroundColor: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } }
                }
            });
        }
        
        // --- [FIXED] ACTIVITY ANALYSIS PAGE FUNCTIONS ---

        function initializeActivityAnalysisPage() {
            if (!isGeneralSecretaryMode) return;
            DOMElements.analysisResultContainer.innerHTML = '<p class="text-gray-500 text-center p-4">الرجاء استخدام الفلاتر أعلاه لإنشاء تقرير.</p>';
            DOMElements.exportAnalysisBtnContainer.classList.add('hidden-view');
        }

        async function generateAbsenceAnalysis() {
            showLoading(true);
            
            const selectedService = DOMElements.analysisServiceFilter.value;
            const selectedYear = DOMElements.analysisYearFilter.value;
            const selectedMonths = Array.from(DOMElements.analysisMonthCheckboxes.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
            const isPercentageMode = DOMElements.analysisModeToggle.checked;

            if (selectedMonths.length === 0) {
                showMessage('الرجاء اختيار شهر واحد على الأقل.', true);
                showLoading(false);
                return;
            }

            let sourceServants = allServantsCache;
            if (selectedService !== 'all') {
                sourceServants = allServantsCache.filter(s => s.serviceName === selectedService);
            }

            const absenceData = {};
            sourceServants.forEach(s => {
                absenceData[s.id] = { name: s.name, serviceName: s.serviceName, absences: 0, totalMeetings: 0 };
            });

            const filteredAttendance = allAttendanceCache.filter(rec => {
                const recDate = new Date(rec.date);
                const recYear = recDate.getFullYear();
                const recMonth = recDate.getMonth() + 1;
                
                const serviceMatch = (selectedService === 'all' || rec.serviceName === selectedService);
                const yearMatch = recYear == selectedYear;
                const monthMatch = selectedMonths.includes(recMonth);

                return serviceMatch && yearMatch && monthMatch;
            });

            filteredAttendance.forEach(day => {
                const serviceServantsOnDate = sourceServants.filter(s => s.serviceName === day.serviceName);
                
                const activityData = day.service; // Analyze absence from the main 'service' activity
                if (activityData && (activityData.note === null || activityData.note === undefined)) {
                    const attendees = new Set(activityData.attendees || []);
                    serviceServantsOnDate.forEach(servant => {
                        if (absenceData[servant.id]) {
                            absenceData[servant.id].totalMeetings++;
                            if (!attendees.has(servant.id)) {
                                absenceData[servant.id].absences++;
                            }
                        }
                    });
                }
            });

            const results = Object.values(absenceData)
                .map(data => ({
                    ...data,
                    value: isPercentageMode 
                        ? (data.totalMeetings > 0 ? ((data.absences / data.totalMeetings) * 100) : 0)
                        : data.absences
                }))
                .filter(data => data.value > 0)
                .sort((a, b) => b.value - a.value);

            renderAbsenceAnalysis(results, isPercentageMode);
            showLoading(false);
        }

        function renderAbsenceAnalysis(results, isPercentageMode) {
            const container = DOMElements.analysisResultContainer;
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-gray-500 dark:text-gray-400"><i class="fas fa-info-circle text-4xl mb-3"></i><p class="font-semibold">لا يوجد غياب مسجل حسب الفلاتر المختارة.</p></div>';
                DOMElements.exportAnalysisBtnContainer.classList.add('hidden-view');
                return;
            }
            
            const tableContainer = document.createElement('div');
            tableContainer.className = "overflow-x-auto";

            const table = document.createElement('table');
            table.className = 'w-full text-right';
            let tableHTML = `
                <thead class="bg-gray-100 dark:bg-gray-700">
                    <tr>
                        <th class="p-4 font-bold text-sm">الاسم</th>
                        <th class="p-4 font-bold text-sm">الخدمة</th>
                        <th class="p-4 font-bold text-sm text-center">${isPercentageMode ? 'نسبة الغياب' : 'عدد مرات الغياب'}</th>
                        <th class="p-4 font-bold text-sm text-center">التفاصيل</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            results.forEach(servant => {
                const valueDisplay = isPercentageMode ? `${servant.value.toFixed(1)}%` : servant.value;
                tableHTML += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="p-4 font-semibold">${servant.name}</td>
                        <td class="p-4 text-gray-600 dark:text-gray-300">${servant.serviceName}</td>
                        <td class="p-4 text-center font-bold text-lg ${getPercentageTextColor(100-servant.value)}">${valueDisplay}</td>
                        <td class="p-4 text-center text-sm text-gray-500">(${servant.absences} غياب من ${servant.totalMeetings} اجتماع)</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);
            
            DOMElements.exportAnalysisBtnContainer.classList.remove('hidden-view');
        }

        async function exportAnalysisAsImage() {
            const container = document.getElementById('activityAnalysisPage').querySelector('.bg-white');
            if(!container) return;
            showMessage('جاري تجهيز الصورة للتصدير...');
            html2canvas(container, { 
                backgroundColor: document.body.classList.contains('dark') ? '#1f2937' : '#ffffff',
                scale: 2,
                useCORS: true 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `absence-analysis-${new Date().toISOString().slice(0,10)}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
        function showActivityAttendees(activityKey) {
            const activity = activityMap.get(activityKey);
            if (!activity) return;

            const { dateString: lastFridayDateString } = getLastFriday();
            const lastFridayData = attendanceYearCache[lastFridayDateString];

            if (!lastFridayData || !lastFridayData[activityKey]) return;

            const attendeesIds = new Set(lastFridayData[activityKey].attendees || []);
            const attendees = servantsCache.filter(s => attendeesIds.has(s.id));

            DOMElements.activityAttendeesModalTitle.textContent = `حضور نشاط: ${activity.name}`;
            const body = DOMElements.activityAttendeesModalBody;
            
            if (attendees.length > 0) {
                body.innerHTML = '<ul class="space-y-2"></ul>';
                const ul = body.querySelector('ul');
                attendees.forEach(servant => {
                    ul.innerHTML += `<li class="p-2 bg-gray-100 dark:bg-gray-700 rounded-md font-semibold">${servant.name}</li>`;
                });
            } else {
                body.innerHTML = '<p class="text-gray-500 text-center">لا يوجد حضور مسجل لهذا النشاط.</p>';
            }

            openModal(DOMElements.activityAttendeesModal);
        }


        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            DOMElements = {
                loadingOverlay: document.getElementById('loadingOverlay'),
                loginOrServicesView: document.getElementById('loginOrServicesView'),
                mainDashboard: document.getElementById('mainDashboard'),
                servicesGrid: document.getElementById('servicesGrid'),
                sidebar: document.getElementById('sidebar'),
                sidebarLinks: document.getElementById('sidebarLinks'),
                sidebarOverlay: document.getElementById('sidebarOverlay'),
                hamburgerBtn: document.getElementById('hamburgerBtn'),
                mobilePageTitle: document.getElementById('mobilePageTitle'),
                servantsTableBody: document.getElementById('servantsTableBody'),
                serviceColumnHeader: document.getElementById('serviceColumnHeader'),
                logoutBtn: document.getElementById('logoutBtn'),
                backToServicesBtn: document.getElementById('backToServices'),
                loginModal: document.getElementById('loginModal'),
                manualEntryModal: document.getElementById('manualEntryModal'),
                importModal: document.getElementById('importModal'),
                confirmModal: document.getElementById('confirmModal'),
                loginForm: document.getElementById('loginForm'),
                codeInput: document.getElementById('codeInput'),
                errorMessage: document.getElementById('errorMessage'),
                manualEntryForm: document.getElementById('manualEntryForm'),
                manualEntryModalTitle: document.getElementById('manualEntryModalTitle'),
                importForm: document.getElementById('importForm'),
                servantImageFile: document.getElementById('servantImageFile'),
                imagePreview: document.getElementById('imagePreview'),
                yearSelector: document.getElementById('yearSelector'),
                monthSelector: document.getElementById('monthSelector'),
                fridaysGrid: document.getElementById('fridaysGrid'),
                activityButtons: document.getElementById('activityButtons'),
                attendanceListContainer: document.getElementById('attendanceListContainer'),
                attendanceListTitle: document.getElementById('attendanceListTitle'),
                servantsChecklist: document.getElementById('servantsChecklist'),
                saveActivityAttendanceBtn: document.getElementById('saveActivityAttendanceBtn'),
                searchInput: document.getElementById('searchInput'),
                reportContent: document.getElementById('reportContent'),
                reportOutput: document.getElementById('reportOutput'),
                generateReportBtn: document.getElementById('generateReportBtn'),
                reportStartDate: document.getElementById('reportStartDate'),
                reportEndDate: document.getElementById('reportEndDate'),
                exportPngBtn: document.getElementById('exportPngBtn'),
                exportPdfBtn: document.getElementById('exportPdfBtn'),
                reportServantSelector: document.getElementById('reportServantSelector'),
                servantSelectorContainer: document.getElementById('servantSelectorContainer'),
                noActivityCheck: document.getElementById('noActivityCheck'),
                noActivityLabel: document.getElementById('noActivityLabel'),
                noActivityReason: document.getElementById('noActivityReason'),
                servantsActions: document.getElementById('servantsActions'),
                serviceFilterContainer: document.getElementById('serviceFilterContainer'),
                reportServiceSelector: document.getElementById('reportServiceSelector'),
                backupRestoreSection: document.getElementById('backupRestoreSection'),
                backupBtn: document.getElementById('backupBtn'),
                restoreBtn: document.getElementById('restoreBtn'),
                totalServantsStat: document.getElementById('totalServantsStat'),
                upcomingBirthdayStat: document.getElementById('upcomingBirthdayStat'),
                lastFridayAbsenceStat: document.getElementById('lastFridayAbsenceStat'),
                lastFridayStatusContainer: document.getElementById('lastFridayStatusContainer'),
                quickAddServant: document.getElementById('quickAddServant'),
                quickGoToAttendance: document.getElementById('quickGoToAttendance'),
                serviceDashboardContainer: document.getElementById('serviceDashboardContainer'),
                adminDashboardContainer: document.getElementById('adminDashboardContainer'),
                adminServantsTableBody: document.getElementById('adminServantsTableBody'),
                adminSearchInput: document.getElementById('adminSearchInput'),
                kpiContainer: document.getElementById('kpiContainer'),
                adminAnnouncementsList: document.getElementById('adminAnnouncementsList'),
                newAnnouncementInput: document.getElementById('newAnnouncementInput'),
                addAnnouncementBtn: document.getElementById('addAnnouncementBtn'),
                announcementsDisplay: document.getElementById('announcementsDisplay'),
                unifiedProfileModal: document.getElementById('unifiedProfileModal'),
                unifiedProfileModalTitle: document.getElementById('unifiedProfileModalTitle'),
                unifiedProfileModalBody: document.getElementById('unifiedProfileModalBody'),
                activityAttendeesModal: document.getElementById('activityAttendeesModal'),
                activityAttendeesModalTitle: document.getElementById('activityAttendeesModalTitle'),
                activityAttendeesModalBody: document.getElementById('activityAttendeesModalBody'),
                comparisonReportTab: document.getElementById('comparisonReportTab'),
                standardReportsContainer: document.getElementById('standardReportsContainer'),
                comparisonReportContainer: document.getElementById('comparisonReportContainer'),
                comparisonServiceSelector1: document.getElementById('comparisonServiceSelector1'),
                comparisonServiceSelector2: document.getElementById('comparisonServiceSelector2'),
                generateComparisonBtn: document.getElementById('generateComparisonBtn'),
                followUpPanel: document.getElementById('followUpPanel'),
                birthdaysPanel: document.getElementById('birthdaysPanel'),
                attendanceFollowUpPanel: document.getElementById('attendanceFollowUpPanel'),
                activityAnalysisLink: document.getElementById('activityAnalysisLink'),
                followUpLink: document.getElementById('followUpLink'),
                analysisServiceFilter: document.getElementById('analysisServiceFilter'),
                analysisYearFilter: document.getElementById('analysisYearFilter'),
                analysisMonthCheckboxes: document.getElementById('analysisMonthCheckboxes'),
                analysisModeToggle: document.getElementById('analysisModeToggle'),
                analysisModeLabel: document.getElementById('analysisModeLabel'),
                generateAnalysisBtn: document.getElementById('generateAnalysisBtn'),
                analysisResultContainer: document.getElementById('analysisResultContainer'),
                exportAnalysisBtnContainer: document.getElementById('exportAnalysisBtnContainer'),
                exportAnalysisBtn: document.getElementById('exportAnalysisBtn'),
                themeCheckbox: document.getElementById('theme-checkbox'),
                totalServantsCard: document.getElementById('totalServantsCard'),
            };

            initializeFirebase();
            populateServices();
            initializeEventListeners();
        });

    </script>
</body>
</html>
